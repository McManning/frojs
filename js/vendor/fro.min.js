/*! frojs 09-07-2015 */
!function(){define("Timer",[],function(){function a(a,b){this.callback=a,this.interval=b,this.running=!1}return a.prototype.tick=function(){if(this.running){var a=Date.now();for(this.callback(this,a-(this.planned-this.interval)),this.lastRun=this.planned,this.planned+=this.interval;this.planned<a;)this.callback(this,0),this.lastRun=this.planned,this.planned+=this.interval;this.timeout=window.setTimeout(this.tick.bind(this),this.planned-a)}},a.prototype.start=function(){this.running||(this.running=!0,this.planned=Date.now()+this.interval,this.lastRun=Date.now(),this.timeout=window.setTimeout(this.tick.bind(this),this.interval))},a.prototype.stop=function(){this.running&&(this.running=!1,window.clearTimeout(this.timeout))},a}),define("EventHooks",[],function(){return{bind:function(a,b,c){if(null===b&&null===c)return this;"function"==typeof b&&(c=b,b=this);for(var d="",e=a.split(","),f=0;f<e.length;f++)a=e[f].trim(),a.indexOf(".")>=0&&(d=a.split("."),a=d.shift(),d.sort(),d=d.join(".")),"undefined"==typeof this._events?(this._events={},this._events[a]=[]):a in this._events||(this._events[a]=[]),this._events[a].push({callback:c,obj:b,namespaces:d});return this},unbind:function(a,b){var c;if(null===b&&("function"==typeof a?(b=a,a=void 0):null===a?(a=void 0,b=void 0):b=void 0),"undefined"!=typeof a){if(a in this._events)if("undefined"!=typeof b)for(c=this._events[a].length;c--;)this._events[a][c]===b&&this._events[a].splice(c,1);else delete this._events[a]}else if("undefined"!=typeof b){for(var d in this._events)if(this._events.hasOwnProperty(d))for(c=this._events[d].length;c--;)this._events[d][c]===b&&this._events[d].splice(c,1)}else this._events={};return this},fire:function(a,b){var c=null;if(~a.indexOf(".")){var d=a.split(".");a=d.shift(),d.length>0&&(d.sort(),c=new RegExp("(^|\\.)"+d.join("\\.(?:.*\\.|)")+"(\\.|$)"))}if("undefined"!=typeof this._events&&a in this._events)for(var e=0;e<this._events[a].length;e++){var f=this._events[a][e];if(!c||c.test(f.namespaces))try{f.callback.apply(f.obj,[b])}catch(g){throw new Error("Exception during event ["+a+"]: "+g.stack)}}}}}),define("Utility",[],function(){var a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return{escape:function(b){return String(b).replace(/[&<>"'\/]/g,function(b){return a[b]})},createMultilineText:function(a,b,c,d){b=b.replace("\n"," ");var e,f,g,h=b,i=0,j=0,k=b.split(" ");for(f=g=k.length;a.measureText(h).width>c&&f>1;){f--,h=e="";for(var l=0;g>l;l++)f>l?(h+=k[l],f>l+1&&(h+=" ")):(e+=k[l],g>l+1&&(e+=" "))}return d.push(h),j=Math.ceil(a.measureText(h).width),e&&(i=this.createMultilineText(a,e,c,d),i>j&&(j=i)),j},getBrowserReport:function(a,b){var c="";if(c+="\nBrowser Details\n",window.navigator){if(c+="* appName: "+window.navigator.appName+"\n",c+="* appVersion: "+window.navigator.appVersion+"\n",c+="* platform: "+window.navigator.platform+"\n",c+="* vendor: "+window.navigator.vendor+"\n",c+="* cookieEnabled: "+window.navigator.cookieEnabled+"\n",window.navigator.plugins&&a){c+="* Plugins\n";for(var d=0;d<window.navigator.plugins.length;d++){var e=window.navigator.plugins[d].name,f=window.navigator.plugins[d].filename;c+="** *"+e+"* - "+f+"\n"}}}else c+="* !window.navigator\n";if(c+="\nWebSocket Details\n",c+="WebSocket"in window?"* WebSocket object support\n":"MozWebSocket"in window?"* MozWebSocket object support\n":"* No WebSocket support\n",c+="\nWebGL Details\n",!b&&!window.gl){var g=document.createElement("canvas");"getContext"in g&&(b=g.getContext("webgl"),b||(b=g.getContext("experimental-webgl")))}if(b){c+="* VERSION: "+b.getParameter(b.VERSION)+"\n",c+="* VENDOR: "+b.getParameter(b.VENDOR)+"\n",c+="* RENDERER: "+b.getParameter(b.RENDERER)+"\n",c+="* SHADING_LANGUAGE_VERSION: "+b.getParameter(b.SHADING_LANGUAGE_VERSION)+"\n";var h=b.getParameter(b.CURRENT_PROGRAM);h&&(c+="* CURRENT_PROGRAM Log: "+b.getProgramInfoLog(b.getParameter(b.CURRENT_PROGRAM))+"\n")}else c+="* No support\n";return c},extend:function(a,b){return Object.keys(b).map(function(c){a.hasOwnProperty(c)||(a[c]=b[c])}),a},hash:function(a){var b,c,d=0,e=a.length;if(0===e)return d;for(b=0;e>b;++b)c=a.charCodeAt(b),d=(d<<5)-d+c,d&=d;return d}}}),define("Audio",["EventHooks","Utility"],function(a,b){function c(c){b.extend(this,a);try{window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext&&(this.audioContext=new window.AudioContext)}catch(d){throw new Error("Failed to initialise AudioContext: "+d)}if(this.audioContext.createGain||(this.audioContext.createGain=this.audioContext.createGainNode),!this.audioContext.createGain)throw new Error("Failed to identify createGain() for audio context");this.audioGainNode=this.audioContext.createGain(),this.audioGainNode.connect(this.audioContext.destination),this.ambientGainNode=this.audioContext.createGain(),this.ambientGainNode.connect(this.audioGainNode)}return c.prototype.isAvailable=function(){return null!==this.audioContext},c.prototype.getAudioContext=function(){return this.audioContext},c.prototype.setMasterVolume=function(a){a>1&&(a=1),this.audioContext&&this.audioGainNode&&(this.audioGainNode.gain.value=a*a,this.fire("setmaster",a))},c.prototype.getMasterVolume=function(){return this.audioContext&&this.audioGainNode?this.audioGainNode.gain.value:0},c.prototype.setAmbientVolume=function(a){a>1&&(a=1),this.audioContext&&this.audioGainNode&&(this.ambientGainNode.gain.value=a*a,this.fire("setambient",a))},c.prototype.getAmbientVolume=function(){return this.audioContext&&this.audioGainNode?this.ambientGainNode.gain.value:0},c.prototype.addConnection=function(a,b){this.audioContext&&(b?a.connect(this.ambientGainNode):a.connect(this.audioGainNode))},c.prototype.play=function(a){this.audioContext&&a.start(0)},c.prototype.stop=function(a){this.audioContext&&a.stop(0)},c}),define("resource/Image",["EventHooks","Utility"],function(a,b){function c(c,d){if(b.extend(this,a),this.type=d.type,this.context=c,this.width=d.width,this.height=d.height,d.hasOwnProperty("shader")&&d.shader?this.shader=c.renderer.getShader(d.shader):this.shader=c.renderer.getDefaultShader(),this.fitToTexture=d.fitToTexture||!0,d.hasOwnProperty("url")){this.url=d.url,this.image=new window.Image,this.image.crossOrigin="",this.image.src=d.url;var e=this;this.image.onload=function(){e.setupTexture(e.image),e.fire("onload",e)},this.image.onerror=function(){e.fire("onerror",e)}}else d.hasOwnProperty("canvas")&&this.setupTexture(d.canvas)}return c.prototype.setupTexture=function(a){this.texture=this.context.renderer.createTexture(a),this.buildVertexBuffer(),this.buildTextureBuffer()},c.prototype.isLoaded=function(){return!!this.texture},c.prototype.getTexture=function(){return this.texture||this.setupTexture(),this.texture},c.prototype.render=function(a,b,c){var d=this.context.renderer.getGLContext();if(this.isLoaded()){if(!this.texture)throw new Error("No texture loaded for image ["+this.id+"]");if(this.context.renderer.useShader(this.shader),d.mvPushMatrix(),mat4.translate(d.mvMatrix,a),b&&mat4.rotateZ(d.mvMatrix,b),d.bindBuffer(d.ARRAY_BUFFER,this.vbuf),d.vertexAttribPointer(this.shader.getAttrib("aVertexPosition"),this.vbuf.itemSize,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,this.tbuf),d.vertexAttribPointer(this.shader.getAttrib("aTextureCoord"),this.tbuf.itemSize,d.FLOAT,!1,0,0),this.shader.bindTexture("uSampler",this.texture),c){if(!this.image)throw new Error("Texture ["+this.id+"] has no image source to clip");var e=0===this.height?1:this.height/this.getTextureHeight(),f=c[0]/this.getTextureWidth(),g=1-e-c[1]/this.getTextureHeight();d.uniform2f(this.shader.getUniform("uClip"),f,g)}else d.uniform2f(this.shader.getUniform("uClip"),0,0);d.setMatrixUniforms(),d.drawArrays(d.TRIANGLE_STRIP,0,this.vbuf.itemCount),d.mvPopMatrix()}},c.prototype.buildVertexBuffer=function(){var a=this.context.renderer.getGLContext();this.vbuf&&a.deleteBuffer(this.vbuf);var b=.5*this.width,c=.5*this.height;this.vbuf=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.vbuf),a.bufferData(a.ARRAY_BUFFER,new glMatrixArrayType([b,-c,b,c,-b,-c,-b,c]),a.STATIC_DRAW),this.vbuf.itemSize=2,this.vbuf.itemCount=4},c.prototype.buildTextureBuffer=function(){var a=this.context.renderer.getGLContext();this.tbuf&&a.deleteBuffer(this.tbuf),this.tbuf=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.tbuf);var b=0,c=0,d=1,e=1;d=this.width/this.getTextureWidth(),e=this.height/this.getTextureHeight(),a.bufferData(a.ARRAY_BUFFER,new glMatrixArrayType([b+d,c,b+d,c+e,b,c,b,c+e]),a.STATIC_DRAW),this.tbuf.itemSize=2,this.tbuf.itemCount=4},c.prototype.getTextureWidth=function(){return this.image?this.image.width:this.width},c.prototype.getTextureHeight=function(){return this.image?this.image.height:this.height},c.shareable=!0,c}),define("resource/Sound",["EventHooks","Utility"],function(a,b){function c(c,d){b.extend(this,a),this.url=d.url,this.type=d.type,this.buffer=null;var e=new window.XMLHttpRequest;e.open("GET",this.url,!0),e.responseType="arraybuffer";var f=this;e.onload=function(){var a=c.audio.getAudioContext();a?a.decodeAudioData(e.response,function(a){f.buffer=a,f.fire("onload",f)},function(){f.fire("onerror",f)}):f.fire("onerror",f)},e.onerror=function(){f.fire("onerror",f)},e.send()}return this.isLoaded=function(){return!!this.buffer},this.getBuffer=function(){return this.buffer},c.shareable=!0,c}),define("resource/Json",["EventHooks","Utility"],function(a,b){function c(c,d){b.extend(this,a),this.url=d.url,this.type=d.type;var e=new window.XMLHttpRequest;e.open("GET",this.url,!0);var f=this;e.onload=function(){e.status>=200&&e.status<400?(f.json=JSON.parse(e.responseText),f.fire("onload",this)):f.fire("onerror",this)},e.onerror=function(){f.fire("onerror",this)},e.send()}return c.prototype.isLoaded=function(){return"object"==typeof this.json},c.prototype.getJson=function(){return this.json},c.shareable=!0,c}),define("resource/Shader",["EventHooks","Utility"],function(a,b){function c(c,d){b.extend(this,a),this.id=d.id,this.type=d.type,this.context=c,this.program=null,this.uniforms=[],this.uniforms.uPMatrix=!1,this.uniforms.uMVMatrix=!1;for(var e=0;e<d.uniforms.length;e++)this.uniforms[d.uniforms[e]]=!1;this.attributes=[];for(var f=0;f<d.attributes.length;f++)this.attributes[d.attributes[f]]=!1;this.fragmentShaderSource=d.fragment,this.vertexShaderSource=d.vertex,this.compileProgram(),this.context.renderer.attachShader(this)}return c.prototype.bindParameters=function(){var a=this.context.renderer.getGLContext();for(var b in this.uniforms)this.uniforms.hasOwnProperty(b)&&(this.uniforms[b]=a.getUniformLocation(this.program,b));for(var c in this.attributes)this.attributes.hasOwnProperty(c)&&(this.attributes[c]=a.getAttribLocation(this.program,c),a.enableVertexAttribArray(this.attributes[c]))},c.prototype.compileProgram=function(){var a=this.context.renderer.getGLContext();if(!this.vertexShaderSource||!this.fragmentShaderSource)throw new Error("Program ["+this.id+"] missing shader sources");this.program&&a.deleteProgram(this.program),this.program=a.createProgram();var c=a.createShader(a.VERTEX_SHADER);if(a.shaderSource(c,this.vertexShaderSource),a.compileShader(c),!a.getShaderParameter(c,a.COMPILE_STATUS))throw new Error("Program "+this.id+" Vertex Shader Error: "+a.getShaderInfoLog(c)+"\n"+b.getBrowserReport(!0,a));a.attachShader(this.program,c);var d=a.createShader(a.FRAGMENT_SHADER);if(a.shaderSource(d,this.fragmentShaderSource),a.compileShader(d),!a.getShaderParameter(d,a.COMPILE_STATUS))throw new Error("Program "+this.id+" Fragment Shader Error: "+a.getShaderInfoLog(d)+"\n"+b.getBrowserReport(!0,a));if(a.attachShader(this.program,d),a.linkProgram(this.program),!a.getProgramParameter(this.program,a.LINK_STATUS))throw new Error("Could not initialize shaders: "+a.getProgramInfoLog(this.program)+"\n"+b.getBrowserReport(!0,a));this.bindParameters()},c.prototype.isLoaded=function(){return!0},c.prototype.getAttrib=function(a){if(!(a in this.attributes))throw new Error("Attribute "+a+" does not exist in program ["+this.id+"]");return this.attributes[a]},c.prototype.getUniform=function(a){if(!(a in this.uniforms))throw new Error("Uniform "+a+" does not exist in program ["+this.id+"]");return this.uniforms[a]},c.prototype.getProgram=function(){return this.program},c.prototype.bindTexture=function(a,b){var c=this.context.renderer.getGLContext();c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,b),c.uniform1i(this.getUniform(a),0)},c.shareable=!0,c}),define("resource/FontImage",["Utility","resource/Image"],function(a,b){function c(a,c){b.call(this,a,c),this.fitToTexture=!1,this.text=c.text||"",this.width=0,this.height=0,this.maxWidth=c.maxWidth||0,this.fontHeight=c.fontHeight||16,this.fontFamily=c.fontFamily||'"Helvetica Neue", Helvetica, Arial, sans-serif',this.fontColor=c.fontColor||"rgb(0,0,0)",this.generateFontTexture(),this.buildVertexBuffer(),this.buildTextureBuffer()}var d=document.createElement("canvas");return c.prototype=Object.create(b.prototype),c.prototype.constructor=c,c.prototype.generateFontTexture=function(){var b=d.getContext("2d"),c=this.text;if(this.text.length<1)throw new Error("No text");b.font=this.fontHeight+"px "+this.fontFamily;var e,f,g,h,i=[];if(this.maxWidth&&b.measureText(c).width>this.maxWidth?(e=a.createMultilineText(b,c,this.maxWidth,i),e>this.maxWidth&&(e=this.maxWidth)):(i.push(c),e=Math.ceil(b.measureText(c).width)),f=this.fontHeight*i.length,1>e||1>f)throw new Error("Invalid canvas dimensions "+e+"x"+f);d.width=e,d.height=f,b.clearRect(0,0,e,f),g=e/2,h=0,b.fillStyle=this.fontColor,b.textAlign="center",b.textBaseline="top",b.font=this.fontHeight+"px "+this.fontFamily;for(var j=0;j<i.length;j++)h=j*this.fontHeight,b.fillText(i[j],g,h);this.texture=this.context.renderer.createTexture(d),this.width=d.width,this.height=d.height},c.prototype.getTextureWidth=function(){return this.width},c.prototype.getTextureHeight=function(){return this.height},c.prototype.isLoaded=function(){return!0},c}),define("resource/Animation",["EventHooks","Utility","Timer"],function(a,b,c){function d(d,e){if(b.extend(this,a),!this.validateMetadata(e))throw new Error("Malformed Animation metadata");this.context=d,this.url=e.url,this.width=e.width,this.height=e.height,this.autoplay=!!e.autoplay,this.keyframes=e.keyframes,this.clip=rect.create(),this.keyframe=null,this.setKeyframe(),this.image=d.resources.load({type:"image",url:e.url,width:e.width,height:e.height,shader:e.shader,fitToTexture:!1}),this.onTimer=this.onTimer.bind(this),this.animateTimer=new c(this.onTimer,this.delay),this.onImageReady=this.onImageReady.bind(this),this.onImageError=this.onImageError.bind(this),this.image.isLoaded()?this.onImageReady():(this.image.bind("onload",this.onImageReady),this.image.bind("onerror",this.onImageError))}var e=100;return d.prototype.validateMetadata=function(a){for(var b=["width","height","url","keyframes"],c=0;c<b.length;c++)if(!a.hasOwnProperty(b[c]))return!1;return!0},d.prototype.next=function(a){this.keyframes.hasOwnProperty(this.keyframe)||this.setKeyframe(),this.keyframes[this.keyframe].frames.length<=this.index+1&&(this.keyframes[this.keyframe].loop||a?this.index=0:this.index-=2),this.frame=this.keyframes[this.keyframe].frames[this.index],this.delay=this.keyframes[this.keyframe].frames[this.index+1],this.delay=Math.max(this.delay,e),this.index+=2,this.updateTextureClip()},d.prototype.setKeyframe=function(a){this.keyframe!==a&&(a&&this.keyframes.hasOwnProperty(a)?(this.keyframe=a,this.reset()):this.keyframe=Object.keys(this.keyframes)[0])},d.prototype.hasKeyframe=function(a){return this.keyframes.hasOwnProperty(a)},d.prototype.reset=function(){this.index=0,this.frame=0,this.next(!1)},d.prototype.updateTextureClip=function(){if(this.image){var a=Math.floor(this.image.getTextureWidth()/this.width),b=this.frame%a,c=(this.frame-b)/a;this.clip[0]=b*this.width,this.clip[1]=c*this.height}},d.prototype.isLoaded=function(){return this.image.isLoaded()},d.prototype.onImageReady=function(){this.reset(),this.autoplay&&this.play(),this.fire("onload",this)},d.prototype.onImageError=function(){this.fire("onerror",this)},d.prototype.render=function(a){this.image&&this.image.render(a,0,this.clip)},d.prototype.onTimer=function(a){this.next(!1),a.interval=this.delay},d.prototype.play=function(){this.animateTimer.interval=this.delay,this.animateTimer.start()},d.prototype.stop=function(){this.animateTimer.stop()},d.prototype.isPlaying=function(){return this.animateTimer.running},d.shareable=!1,d}),define("Resources",["EventHooks","Utility","resource/Image","resource/Sound","resource/Json","resource/Shader","resource/FontImage","resource/Animation"],function(a,b,c,d,e,f,g,h){function i(i){b.extend(this,a),this.resourceTypes={image:c,sound:d,json:e,shader:f,text:g,animation:h},this.context=i,this.loaded={},this.failed={},this.totalPreload=0,this.completedPreload=0,this.onPreloadResourceComplete=this.onPreloadResourceComplete.bind(this),this.onPreloadResourceError=this.onPreloadResourceError.bind(this)}return i.prototype.preload=function(a){if(this.totalPreload=0,this.completedPreload=0,a.hasOwnProperty("required")){this.totalPreload+=a.required.length;for(var b=0;b<a.required.length;b++)this._preloadResource(a.required[b])}return this},i.prototype.isPreloadComplete=function(){return this.totalPreload===this.completedPreload},i.prototype._preloadResource=function(a){var b=this.load(a);b.isLoaded()?this.onPreloadResourceComplete(b):b.bind("onload",this.onPreloadResourceComplete).bind("onerror",this.onPreloadResourceError)},i.prototype.onPreloadResourceComplete=function(a){this.completedPreload++,this.fire("preload.status",a),this.completedPreload===this.totalPreload&&this.fire("preload.complete")},i.prototype.onPreloadResourceError=function(a){this.failed[a._resourceId]=a,this.fire("preload.error",a)},i.prototype.isLoaded=function(a){return this.loaded.hasOwnProperty(a)},i.prototype.load=function(a){if(!a.hasOwnProperty("type"))throw new Error("JSON resource is missing required attribute [type]: "+JSON.stringify(a));var c=b.hash(JSON.stringify(a)),d=a.type;if(!this.resourceTypes.hasOwnProperty(d))throw this.failed[c]=a,new Error("Cannot load ["+c+"]. No loader for type ["+d+"]");console.log(this.resourceTypes[d].shareable);var e=this.resourceTypes[d].shareable;if(e&&this.loaded.hasOwnProperty(c))return this.loaded[c];var f=new this.resourceTypes[d](this.context,a);return f._resourceId=c,e&&(this.loaded[c]=f),f},i}),define("text",["module"],function(a){"use strict";var b,c,d,e,f,g=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],h=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,i=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,j="undefined"!=typeof location&&location.href,k=j&&location.protocol&&location.protocol.replace(/\:/,""),l=j&&location.hostname,m=j&&(location.port||void 0),n={},o=a.config&&a.config()||{};return b={version:"2.0.14",strip:function(a){if(a){a=a.replace(h,"");var b=a.match(i);b&&(a=b[1])}else a="";return a},jsEscape:function(a){return a.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:o.createXhr||function(){var a,b,c;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(b=0;3>b;b+=1){c=g[b];try{a=new ActiveXObject(c)}catch(d){}if(a){g=[c];break}}return a},parseName:function(a){var b,c,d,e=!1,f=a.lastIndexOf("."),g=0===a.indexOf("./")||0===a.indexOf("../");return-1!==f&&(!g||f>1)?(b=a.substring(0,f),c=a.substring(f+1)):b=a,d=c||b,f=d.indexOf("!"),-1!==f&&(e="strip"===d.substring(f+1),d=d.substring(0,f),c?c=d:b=d),{moduleName:b,ext:c,strip:e}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(a,c,d,e){var f,g,h,i=b.xdRegExp.exec(a);return i?(f=i[2],g=i[3],g=g.split(":"),h=g[1],g=g[0],!(f&&f!==c||g&&g.toLowerCase()!==d.toLowerCase()||(h||g)&&h!==e)):!0},finishLoad:function(a,c,d,e){d=c?b.strip(d):d,o.isBuild&&(n[a]=d),e(d)},load:function(a,c,d,e){if(e&&e.isBuild&&!e.inlineText)return void d();o.isBuild=e&&e.isBuild;var f=b.parseName(a),g=f.moduleName+(f.ext?"."+f.ext:""),h=c.toUrl(g),i=o.useXhr||b.useXhr;return 0===h.indexOf("empty:")?void d():void(!j||i(h,k,l,m)?b.get(h,function(c){b.finishLoad(a,f.strip,c,d)},function(a){d.error&&d.error(a)}):c([g],function(a){b.finishLoad(f.moduleName+"."+f.ext,f.strip,a,d)}))},write:function(a,c,d,e){if(n.hasOwnProperty(c)){var f=b.jsEscape(n[c]);d.asModule(a+"!"+c,"define(function () { return '"+f+"';});\n")}},writeFile:function(a,c,d,e,f){var g=b.parseName(c),h=g.ext?"."+g.ext:"",i=g.moduleName+h,j=d.toUrl(g.moduleName+h)+".js";b.load(i,d,function(c){var d=function(a){return e(j,a)};d.asModule=function(a,b){return e.asModule(a,j,b)},b.write(a,i,d,f)},f)}},"node"===o.env||!o.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]&&!process.versions["atom-shell"]?(c=require.nodeRequire("fs"),b.get=function(a,b,d){try{var e=c.readFileSync(a,"utf8");"\ufeff"===e[0]&&(e=e.substring(1)),b(e)}catch(f){d&&d(f)}}):"xhr"===o.env||!o.env&&b.createXhr()?b.get=function(a,c,d,e){var f,g=b.createXhr();if(g.open("GET",a,!0),e)for(f in e)e.hasOwnProperty(f)&&g.setRequestHeader(f.toLowerCase(),e[f]);o.onXhr&&o.onXhr(g,a),g.onreadystatechange=function(b){var e,f;4===g.readyState&&(e=g.status||0,e>399&&600>e?(f=new Error(a+" HTTP status: "+e),f.xhr=g,d&&d(f)):c(g.responseText),o.onXhrComplete&&o.onXhrComplete(g,a))},g.send(null)}:"rhino"===o.env||!o.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?b.get=function(a,b){var c,d,e="utf-8",f=new java.io.File(a),g=java.lang.System.getProperty("line.separator"),h=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(f),e)),i="";try{for(c=new java.lang.StringBuffer,d=h.readLine(),d&&d.length()&&65279===d.charAt(0)&&(d=d.substring(1)),null!==d&&c.append(d);null!==(d=h.readLine());)c.append(g),c.append(d);i=String(c.toString())}finally{h.close()}b(i)}:("xpconnect"===o.env||!o.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(d=Components.classes,e=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),f="@mozilla.org/windows-registry-key;1"in d,b.get=function(a,b){var c,g,h,i={};f&&(a=a.replace(/\//g,"\\")),h=new FileUtils.File(a);try{c=d["@mozilla.org/network/file-input-stream;1"].createInstance(e.nsIFileInputStream),c.init(h,1,0,!1),g=d["@mozilla.org/intl/converter-input-stream;1"].createInstance(e.nsIConverterInputStream),g.init(c,"utf-8",c.available(),e.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),g.readString(c.available(),i),g.close(),c.close(),b(i.value)}catch(j){throw new Error((h&&h.path||"")+": "+j)}}),b}),define("text!shaders/main.vs",[],function(){return"\r\nattribute vec3 aVertexPosition;\r\nattribute vec2 aTextureCoord;\r\n\r\nuniform mat4 uMVMatrix;\r\nuniform mat4 uPMatrix;\r\nuniform vec4 uColor;\r\n\r\nvarying vec2 vTextureCoord;\r\nvarying vec4 vWorldCoord;\r\n\r\nvoid main(void) {\r\n    \r\n    vWorldCoord = uMVMatrix * vec4(aVertexPosition, 1.0);\r\n    vTextureCoord = aTextureCoord;\r\n\r\n    gl_Position = uPMatrix * vWorldCoord;\r\n    \r\n    /*\r\n        gl_Position is absolute screen position [0, 1] (ie: @ screen x = 800, gl_Position.x = 1)\r\n        uMVMatrix * aVertexPos = is screen position in pixels (ie: x = (0, 800))\r\n        aVertexPos = [0, 1], where 0 is the left edge of the object rendered\r\n        gl_FragCoord (frag) = screen position, therefore same as uMVMatrix * aVertexPos?\r\n    */\r\n}\r\n"}),define("text!shaders/main.fs",[],function(){return"precision mediump float;\r\n\r\nvarying vec2 vTextureCoord;\r\nvarying vec4 vWorldCoord;\r\n\r\nuniform sampler2D uSampler;\r\nuniform vec2 uClip;\r\nuniform float uTime;\r\nuniform vec3 uCamera;\r\n\r\nvoid main(void) {\r\n    gl_FragColor = texture2D(uSampler, vTextureCoord + uClip);\r\n}\r\n"}),define("Renderer",["text!shaders/main.vs","text!shaders/main.fs"],function(a,b){function c(c,d){if(this.canvas=d.canvas,this.usesWebGL=!0,this.shaders=[],this.currentShader=null,this.clearStyle="rgb(0,0,0)",this.gl=null,!this.canvas)throw new Error("No canvas specified");try{var e=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");this.gl=e,this.usesWebGL=!0}catch(f){this.usesWebGL=!1}if(!this.gl)throw new Error("No WebGL support");this.gl.viewportWidth=this.canvas.width,this.gl.viewportHeight=this.canvas.height,this.gl.mvMatrix=mat4.create(),this.gl.pMatrix=mat4.create(),this.gl.mvMatrixStack=[],this.gl.mvPopMatrix=function(){if(0===this.mvMatrixStack.length)throw new Error("Invalid popMatrix!");this.mvMatrix=this.mvMatrixStack.pop()},this.gl.mvPushMatrix=function(){var a=mat4.create();mat4.set(this.mvMatrix,a),this.mvMatrixStack.push(a)};var g=this;this.gl.setMatrixUniforms=function(){var a=g.getCurrentShader();this.uniformMatrix4fv(a.getUniform("uPMatrix"),!1,this.pMatrix),this.uniformMatrix4fv(a.getUniform("uMVMatrix"),!1,this.mvMatrix)},this.gl.enable(this.gl.BLEND),this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,0,0,1),d.hasOwnProperty("background")&&this.setClearColor(d.background),c.renderer=this,this.defaultShader=c.resources.load({id:"shader:default",type:"shader",vertex:a,fragment:b,uniforms:["uTime","uCamera","uClip","uSampler","uMVMatrix","uPMatrix"],attributes:["aVertexPosition","aTextureCoord"]})}return c.prototype.isWebGL=function(){return this.usesWebGL===!0},c.prototype.getGLContext=function(){return this.gl},c.prototype.getCanvas=function(){return this.canvas},c.prototype.clear=function(){if(!this.isWebGL())throw new Error("Not supported");this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},c.prototype.createTexture=function(a){var b,c=this.gl;if(!this.isWebGL())throw new Error("Not supported");return b=c.createTexture(),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.bindTexture(c.TEXTURE_2D,b),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.bindTexture(c.TEXTURE_2D,null),b},c.prototype.setClearColor=function(a){this.clearStyle="rgb("+a[0]+","+a[1]+","+a[2]+")",this.isWebGL()&&this.gl.clearColor(a[0]/255,a[1]/255,a[2]/255,1)},c.prototype.useShader=function(a){a||(a=this.getDefaultShader()),this.currentShader=a,this.gl.useProgram(a.getProgram())},c.prototype.attachShader=function(a){this.shaders[a.id]=a},c.prototype.getCurrentShader=function(){return this.currentShader},c.prototype.getShader=function(a){if(!this.shaders.hasOwnProperty(a))throw new Error("Shader ["+a+"] is not loaded");return this.shaders[a]},c.prototype.getDefaultShader=function(){return this.defaultShader},c.prototype.setDefaultShader=function(a){this.defaultShader=a},c}),define("Camera",["EventHooks","Utility"],function(a,b){function c(c,d){b.extend(this,a),this.followedEntity=!1,this.position=vec3.create(),this.zoom=1,this.lastFollowedPosition=vec3.create(),this.translation=vec3.create(),this.bounds=rect.create(),this.context=c,d.hasOwnProperty("bounds")&&this.setBounds(d.bounds)}return c.prototype.setupViewport=function(){var a=this.context.renderer.getGLContext();this.update(),(a.canvas.width!==a.canvas.clientWidth||a.canvas.height!==a.canvas.clientHeight)&&(a.canvas.width=a.canvas.clientWidth,a.canvas.height=a.canvas.clientHeight,a.viewportWidth=2*Math.round(.5*a.canvas.width),a.viewportHeight=2*Math.round(.5*a.canvas.height),this.applyBounds(),this.updateTranslation()),this.context.renderer.isWebGL()?(a.viewport(0,0,a.viewportWidth,a.viewportHeight),mat4.ortho(0,a.viewportWidth*this.zoom,0,a.viewportHeight*this.zoom,0,-1e3,a.pMatrix),mat4.identity(a.mvMatrix)):a.setTransform(1,0,0,1,0,0),mat4.translate(a.mvMatrix,this.translation),this.context.renderer.clear()},c.prototype.setBounds=function(a){rect.set(a,this.bounds)},c.prototype.followEntity=function(a){if("function"!=typeof a.getPosition)throw"Followed entity must have a getPosition() method.";this.followedEntity=a,this.fire("follow",a)},c.prototype.getFollowedEntity=function(){return this.followedEntity},c.prototype.updateTranslation=function(){var a=this.context.renderer.getGLContext();this.translation[0]=a.viewportWidth*this.zoom*.5-this.position[0],this.translation[1]=a.viewportHeight*this.zoom*.5-this.position[1]},c.prototype.setCenter=function(a){this.followedEntity=null,this.position[0]=a[0],this.position[1]=a[1],this.applyBounds(),this.updateTranslation(),this.fire("move",this.position)},c.prototype.getCenter=function(){return this.position},c.prototype.update=function(){if(this.followedEntity){var a=this.followedEntity.getPosition();vec3.equals(this.lastFollowedPosition,a)||(vec3.set(a,this.lastFollowedPosition),vec3.set(a,this.position),this.position[1]+=a[2],this.applyBounds(),this.updateTranslation(),this.fire("move",this.position))}},c.prototype.canvasVec3ToWorld=function(a){var b=this.context.renderer.getGLContext();a[0]=Math.floor((a[0]-.5*b.viewportWidth)*this.zoom+this.position[0]),a[1]=Math.floor((b.viewportHeight-a[1]-.5*b.viewportHeight)*this.zoom+this.position[1])},c.prototype.applyBounds=function(){var a=this.context.renderer.getGLContext();if(this.bounds[0]!==this.bounds[2]&&this.bounds[1]!==this.bounds[3]){var b=a.viewportWidth*this.zoom,c=a.viewportHeight*this.zoom,d=this.position[0]-.5*b,e=this.position[1]-.5*c;d<this.bounds[0]&&(d=this.bounds[0]),d+b>=this.bounds[2]&&(d=this.bounds[2]-b),e<this.bounds[1]&&(e=this.bounds[1]),e+c>=this.bounds[3]&&(e=this.bounds[3]-c),this.position[0]=d+.5*b,this.position[1]=e+.5*c}},c}),define("Input",["EventHooks","Utility"],function(a,b){function c(c,d){b.extend(this,a),this.pressedKeys=[],this.cursorPosition=vec3.create(),this.context=c,this.canvasFocus=!1;var e=c.renderer.getCanvas();e.setAttribute("tabindex",-1),this.onCanvasFocus=this.onCanvasFocus.bind(this),this.onCanvasBlur=this.onCanvasBlur.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onKeyUp=this.onKeyUp.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.onWindowFocus=this.onWindowFocus.bind(this),this.onWindowBlur=this.onWindowBlur.bind(this),e.addEventListener("mousedown",this.onMouseDown),e.addEventListener("focus",this.onCanvasFocus),e.addEventListener("blur",this.onCanvasBlur),document.addEventListener("mouseup",this.onMouseUp),document.addEventListener("mousemove",this.onMouseMove),window.addEventListener("keyup",this.onKeyUp),window.addEventListener("keydown",this.onKeyDown),window.onfocus=this.onWindowFocus,window.onblur=this.onWindowBlur}return"undefined"==typeof window.KeyEvent&&(window.KeyEvent={DOM_VK_CANCEL:3,DOM_VK_HELP:6,DOM_VK_BACK_SPACE:8,DOM_VK_TAB:9,DOM_VK_CLEAR:12,DOM_VK_RETURN:13,DOM_VK_ENTER:14,DOM_VK_SHIFT:16,DOM_VK_CONTROL:17,DOM_VK_ALT:18,DOM_VK_PAUSE:19,DOM_VK_CAPS_LOCK:20,DOM_VK_ESCAPE:27,DOM_VK_SPACE:32,DOM_VK_PAGE_UP:33,DOM_VK_PAGE_DOWN:34,DOM_VK_END:35,DOM_VK_HOME:36,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_PRINTSCREEN:44,DOM_VK_INSERT:45,DOM_VK_DELETE:46,DOM_VK_0:48,DOM_VK_1:49,DOM_VK_2:50,DOM_VK_3:51,DOM_VK_4:52,DOM_VK_5:53,DOM_VK_6:54,DOM_VK_7:55,DOM_VK_8:56,DOM_VK_9:57,DOM_VK_SEMICOLON:59,DOM_VK_EQUALS:61,DOM_VK_A:65,DOM_VK_B:66,DOM_VK_C:67,DOM_VK_D:68,DOM_VK_E:69,DOM_VK_F:70,DOM_VK_G:71,DOM_VK_H:72,DOM_VK_I:73,DOM_VK_J:74,DOM_VK_K:75,DOM_VK_L:76,DOM_VK_M:77,DOM_VK_N:78,DOM_VK_O:79,DOM_VK_P:80,DOM_VK_Q:81,DOM_VK_R:82,DOM_VK_S:83,DOM_VK_T:84,DOM_VK_U:85,DOM_VK_V:86,DOM_VK_W:87,DOM_VK_X:88,DOM_VK_Y:89,DOM_VK_Z:90,DOM_VK_CONTEXT_MENU:93,DOM_VK_NUMPAD0:96,DOM_VK_NUMPAD1:97,DOM_VK_NUMPAD2:98,DOM_VK_NUMPAD3:99,DOM_VK_NUMPAD4:100,DOM_VK_NUMPAD5:101,DOM_VK_NUMPAD6:102,DOM_VK_NUMPAD7:103,DOM_VK_NUMPAD8:104,
DOM_VK_NUMPAD9:105,DOM_VK_MULTIPLY:106,DOM_VK_ADD:107,DOM_VK_SEPARATOR:108,DOM_VK_SUBTRACT:109,DOM_VK_DECIMAL:110,DOM_VK_DIVIDE:111,DOM_VK_F1:112,DOM_VK_F2:113,DOM_VK_F3:114,DOM_VK_F4:115,DOM_VK_F5:116,DOM_VK_F6:117,DOM_VK_F7:118,DOM_VK_F8:119,DOM_VK_F9:120,DOM_VK_F10:121,DOM_VK_F11:122,DOM_VK_F12:123,DOM_VK_F13:124,DOM_VK_F14:125,DOM_VK_F15:126,DOM_VK_F16:127,DOM_VK_F17:128,DOM_VK_F18:129,DOM_VK_F19:130,DOM_VK_F20:131,DOM_VK_F21:132,DOM_VK_F22:133,DOM_VK_F23:134,DOM_VK_F24:135,DOM_VK_NUM_LOCK:144,DOM_VK_SCROLL_LOCK:145,DOM_VK_COMMA:188,DOM_VK_PERIOD:190,DOM_VK_SLASH:191,DOM_VK_BACK_QUOTE:192,DOM_VK_OPEN_BRACKET:219,DOM_VK_BACK_SLASH:220,DOM_VK_CLOSE_BRACKET:221,DOM_VK_QUOTE:222,DOM_VK_META:224}),c.prototype.onKeyDown=function(a){return a=a||window.event,this.pressedKeys[a.keyCode]=!0,this.fire("keydown",a),a.keyCode===window.KeyEvent.DOM_VK_PAGE_UP||a.keyCode===window.KeyEvent.DOM_VK_PAGE_DOWN?!1:void 0},c.prototype.onKeyUp=function(a){a=a||window.event,this.pressedKeys[a.keyCode]=!1,this.fire("keyup",a)},c.prototype.onMouseDown=function(a){a=a||window.event,this.updateCursorPosition(a),this.fire("mousedown",a)},c.prototype.onMouseUp=function(a){a=a||window.event,this.updateCursorPosition(a),this.fire("mouseup",a)},c.prototype.onMouseMove=function(a){a=a||window.event,this.updateCursorPosition(a)},c.prototype.updateCursorPosition=function(a){var b=this.cursorPosition,c=this.context.renderer.getCanvas();a.pageX||a.pageY?(b[0]=a.pageX,b[1]=a.pageY):(b[0]=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,b[1]=a.clientY+document.body.scrollTop+document.documentElement.scrollTop),b[0]-=c.offsetLeft,b[1]-=c.offsetTop},c.prototype.onCanvasBlur=function(){this.pressedKeys.length=0,this.canvasFocus=!1,this.fire("canvasblur")},c.prototype.onCanvasFocus=function(){this.canvasFocus=!0,this.fire("canvasfocus")},c.prototype.onWindowBlur=function(){this.pressedKeys.length=0,this.canvasFocus=!1,this.fire("windowblur")},c.prototype.onWindowFocus=function(){this.fire("windowfocus")},c.prototype.isKeyDown=function(a){return this.pressedKeys[a]===!0},c.prototype.hasFocus=function(){return this.canvasFocus},c.prototype.getCursorPosition=function(){return vec3.create(this.cursorPosition)},c}),define("entity/Entity",["EventHooks","Utility"],function(a,b){function c(c,d){b.extend(this,a),this.id=d.id,this.isRenderable=!1,this.visible=!0,this.position=vec3.create(),this.offset=vec3.create(),this.translation=vec3.create(),this.context=c,this.children=[],this.parent=null}return c.prototype.destroy=function(){if(this.fire("destroy"),this.parent&&this.parent.removeChild(this),this.children)for(var a=0;a<this.children.length;a++)this.children[a].setParent(null),this.children[a].destroy();this.context.world.remove(this)},c.prototype.addChild=function(a){this.children.push(a),a.setParent(this),this.fire("add",a)},c.prototype.removeChild=function(a){var b=this.children.indexOf(a);~b&&(this.children.splice(b,1),a.setParent(null),this.fire("remove",a))},c.prototype.setParent=function(a){this.parent=a,this.fire("parent",a)},c.prototype.getPosition=function(){return vec3.create(this.position)},c.prototype.getWorldPosition=function(){var a=this.getPosition();return this.parent&&vec3.add(a,this.parent.getWorldPosition()),a},c.prototype.setPosition=function(a){this.position[0]=Math.floor(a[0]),this.position[1]=Math.floor(a[1]),a.length>2&&(this.position[2]=Math.floor(a[2])),this.updateTranslation()},c.prototype.getOffset=function(){return this.offset},c.prototype.setOffset=function(a){this.offset[0]=Math.floor(a[0]),this.offset[1]=Math.floor(a[1]),this.updateTranslation()},c.prototype.getBoundingBox=function(a){a[0]=0,a[1]=0,a[2]=0,a[3]=0},c.prototype.getRenderable=function(){return this.isRenderable},c.prototype.setRenderable=function(a){this.isRenderable=a},c.prototype.updateTranslation=function(){var a=this.getWorldPosition();if(vec3.add(a,this.offset),!vec3.equals(a,this.translation)){vec3.set(a,this.translation);for(var b=0;b<this.children.length;b++)this.children[b].updateTranslation()}},c.prototype.collides=function(a){},c}),define("entity/Prop",["entity/Entity"],function(a){function b(b,c){if(a.call(this,b,c),this.width=c.w,this.height=c.h,this.isRenderable=!0,this.collisions=[],c.hasOwnProperty("collisions")&&this.loadCollisions(c.collisions),c.hasOwnProperty("offset")&&this.setOffset(c.offset),this.setPosition(c.position),this.image=b.resources.load(c.image),!this.image.isLoaded()){var d=this;this.image.bind("onerror",function(){throw new Error("Failed to load prop image for ["+d.id+"]")})}}return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b.prototype.isLoaded=function(){return this.image.isLoaded()},b.prototype.loadCollisions=function(a){this.collisions=[];for(var b=0;b<a.length;b+=4){var c=rect.create([a[b],a[b+1],a[b+2],a[b+3]]);this.collisions.push(c)}},b.prototype.render=function(){this.image.render(this.translation,0)},b.prototype.getBoundingBox=function(a){a[0]=this.position[0]+this.offset[0],a[1]=this.position[1]+this.offset[1],a[2]=this.width,a[3]=this.height},b.prototype.collides=function(a){var b=rect.create(a),c=this.getPosition();b[0]-=c[0],b[1]-=c[1];var d=this.collisions;if(d)for(var e in d)if(rect.intersects(b,d[e]))return!0;return!1},b}),define("Enum",[],function(){var a={Direction:{NONE:0,NORTH:8,SOUTH:2,EAST:6,WEST:4,NORTHEAST:9,NORTHWEST:7,SOUTHEAST:3,SOUTHWEST:1,toChar:function(a){return a>0&&10>a?a.toString():"0"},fromChar:function(a){var b=parseInt(a);return b>0&&10>b?b:this.NONE},toVec3:function(a){var b=[0,0];switch(a){case this.NORTH:b=[0,1];break;case this.NORTHEAST:b=[1,1];break;case this.NORTHWEST:b=[-1,1];break;case this.SOUTH:b=[0,-1];break;case this.SOUTHEAST:b=[1,-1];break;case this.SOUTHWEST:b=[-1,-1];break;case this.EAST:b=[1,0];break;case this.WEST:b=[-1,0]}return b[2]=0,vec3.create(b)},fromVec3:function(b){var c=vec3.create(),d=this.NONE;return vec3.normalize(b,c),c[1]>0?d=c[0]>0?a.Direction.NORTHEAST:c[0]<0?a.Direction.NORTHWEST:a.Direction.NORTH:c[1]<0?d=c[0]>0?a.Direction.SOUTHEAST:c[0]<0?a.Direction.SOUTHWEST:a.Direction.SOUTH:c[0]>0?d=a.Direction.EAST:c[0]<0&&(d=a.Direction.WEST),d}},Speed:{WALK:4,RUN:8},Action:{IDLE:0,MOVE:1,SIT:2,JUMP:3}};return Object.freeze&&Object.freeze(a),a}),define("entity/Actor",["Enum","Utility","Timer","entity/Entity"],function(a,b,c,d){function e(b,e){d.call(this,b,e),this.isRenderable=!0,this.step=0,this.action=e.action||a.Action.IDLE,this.speed=e.speed||a.Speed.WALK,this.direction=e.direction||a.Direction.SOUTH,this.buffer="",this.destination=vec3.create(),this.directionNormal=vec3.create(),this.setPosition(e.position||[0,0,0]),this.setName(e.name||""),this.onThink=this.onThink.bind(this),this.thinkTimer=new c(this.onThink,g),this.thinkTimer.start(),e.hasOwnProperty("avatar")&&this.loadAvatar(e.avatar)}var f=16,g=50;return e.prototype=Object.create(d.prototype),e.prototype.constructor=e,e.prototype.destroy=function(){this.thinkTimer&&this.thinkTimer.stop(),d.prototype.destroy.call(this)},e.prototype.setName=function(a){this.name=a,this.fire("name",this)},e.prototype.loadAvatar=function(a){var b=this.context.resources.load(a);if(b.isLoaded())this.setAvatar(b);else{var c=this;b.bind("onload",function(){c.setAvatar(b)}).bind("onerror",function(){throw new Error("Failed to load prop image for ["+c.id+"]")})}},e.prototype.setAvatar=function(a){this.avatar=a,this.offset[1]=.5*this.avatar.height,this.updateTranslation(),this.recalculateAvatarRow(),this.fire("avatar",this)},e.prototype.addToActionBuffer=function(a){this.fire("add.buffer",a),this.buffer+=a},e.prototype.say=function(a){this.fire("say",{entity:this,message:a})},e.prototype.render=function(){this.avatar&&this.avatar.render(this.translation,0)},e.prototype.canMove=function(b){var c=a.Direction.toVec3(b);vec3.scale(c,f);var d=rect.create([this.position[0]+c[0]-8,this.position[1]+c[1],16,16]);return!this.context.world.isRectBlocked(d,this)},e.prototype.isMoving=function(){var a=this.getPosition();return a[0]!==this.destination[0]||a[1]!==this.destination[1]},e.prototype.getBoundingBox=function(a){var b=this.position;this.avatar?(a[0]=b[0],a[1]=b[1]+.5*this.avatar.height,a[2]=this.avatar.width,a[3]=this.avatar.height):(a[0]=b[0],a[1]=b[1],a[2]=0,a[3]=0)},e.prototype.setPosition=function(a){d.prototype.setPosition.call(this,a),vec3.set(this.position,this.destination),this.fire("move",this.position)},e.prototype.setDestination=function(a){this.destination[0]=Math.floor(a[0]),this.destination[1]=Math.floor(a[1])},e.prototype.setAction=function(a){this.action=a,this.recalculateAvatarRow()},e.prototype.setSpeed=function(a){this.speed=a},e.prototype.setDirection=function(a){this.direction=a,this.recalculateAvatarRow()},e.prototype.onThink=function(){this.isMoving()||this.processActionBuffer(),this.isMoving()?(this.avatar.stop(),this.processMovement()):this.action===a.Action.MOVE&&(this.setAction(a.Action.IDLE),this.avatar.play())},e.prototype.processActionBuffer=function(){var b,c,d,e;if(this.buffer)do b=this.buffer.charAt(0),e=a.Direction.fromChar(b),c=!1,d=1,e!==a.Direction.NONE?this.stepInDirection(e):"w"===b?(this.setSpeed(a.Speed.WALK),c=!0):"r"===b?(this.setSpeed(a.Speed.RUN),c=!0):"s"===b?(this.buffer.length>1&&(e=a.Direction.fromChar(this.buffer.charAt(1)),this.setDirection(e),d++),this.setAction(a.Action.SIT)):"t"===b&&(this.buffer.length>1&&(e=a.Direction.fromChar(this.buffer.charAt(1)),this.setDirection(e),d++),this.setAction(a.Action.IDLE)),this.buffer=this.buffer.substr(d);while(c&&this.buffer)},e.prototype.processMovement=function(){var b=this.getPosition(),c=this.directionNormal;vec3.subtract(this.destination,b,c);var e=vec3.length(c);vec3.normalize(c),e<this.speed?(vec3.scale(c,e),e=0):(vec3.scale(c,this.speed),e-=this.speed),this.action!==a.Action.MOVE&&this.setAction(a.Action.MOVE),e>0?(c[0]=Math.ceil(c[0]),c[1]=Math.ceil(c[1]),vec3.add(b,c),d.prototype.setPosition.call(this,b)):(vec3.set(this.destination,b),d.prototype.setPosition.call(this,b));var f=a.Direction.fromVec3(c);f!==this.direction&&this.setDirection(f),this.step<2?this.step++:(this.step=0,this.avatar.next(!0),this.context.world.resort()),this.fire("move",this.position)},e.prototype.recalculateAvatarRow=function(){var b;b=this.direction===a.Direction.NORTH||this.direction===a.Direction.NORTHEAST||this.direction===a.Direction.NORTHWEST?8:this.direction===a.Direction.SOUTH||this.direction===a.Direction.SOUTHEAST||this.direction===a.Direction.SOUTHWEST?2:this.direction===a.Direction.WEST?4:this.direction===a.Direction.EAST?6:2;var c="stop_";this.action!==a.Action.MOVE&&this.avatar.hasKeyframe(c+b)||(c="move_"),this.action===a.Action.SIT&&(c="act_",this.avatar.hasKeyframe(c+b)||(c="move_")),this.avatar.hasKeyframe(c+b)||(c="move_",b="2"),this.avatar.setKeyframe(c+b)},e.prototype.stepInDirection=function(b){vec3.set(this.getPosition(),this.destination);var c=a.Direction.toVec3(b);vec3.add(this.destination,vec3.scale(c,f))},e}),define("entity/Sound",["entity/Entity"],function(a){function b(b,c){if(a.call(this,b,c),this.positional=c.positional||!1,this.loop=c.loop||!1,this.autoplay=c.autoplay||!0,this.ambient=c.ambient||!1,this.positional&&this.setPosition(c.x,c.y),this.context.audio.isAvailable()){this.audioGainNode=this.context.audio.getAudioContext().createGain(),this.setVolume(c.volume||100);var d=this.context.resources.load(c.sound);if(d.isLoaded())this.setBuffer(d.getBuffer());else{var e=this;d.bind("onload",function(){e.setBuffer(this.getBuffer())}).bind("onerror",function(){})}}}return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b.prototype.destroy=function(){this.stop(),this.audioBuffer&&(this.audioGainNode.disconnect(0),this.audioGainNode=void 0),a.prototype.destroy.call(this)},b.prototype.setBuffer=function(a){this.sourceBuffer=a,this.autoplay&&this.play()},b.prototype.setVolume=function(a){a>1&&(a=1),this.volume=a,this.audioGainNode&&(this.audioGainNode.gain.value=a*a)},b.prototype.play=function(){if(this.stop(),this.context.audio.isAvailable()){var a=this.context.audio.getAudioContext().createBufferSource();a.buffer=this.sourceBuffer,a.loop=this.loop,a.start||(a.start=a.noteOn),a.stop||(a.stop=a.noteOff),this.audioBuffer=a,this.audioBuffer.connect(this.audioGainNode),this.context.audio.addConnection(this.audioGainNode,this.ambient),this.context.audio.play(this.audioBuffer)}},b.prototype.stop=function(){this.audioBuffer&&(this.context.audio.stop(this.audioBuffer),this.audioBuffer=void 0)},b}),define("World",["EventHooks","Utility","entity/Prop","entity/Actor","entity/Sound"],function(a,b,c,d,e){function f(f,g){b.extend(this,a),this.loaders={prop:c,sound:e,actor:d},this.renderableEntities=[],this.context=f,this.otherEntities=[],this.id=g.id||"",this.templates=g.templates||{},this.loadEntities(g.entities||[])}return f.prototype.getTemplate=function(a){for(var b=0;b<this.templates.length;b++)if(this.templates[b].id===a)return this.templates[b];return{}},f.prototype.loadEntities=function(a){for(var b,c=[],d=0;d<a.length;d++)b=this.loadEntity(a[d]),b&&c.push(b);return c},f.prototype.loadEntity=function(a){var c,d=a.id,e=null,f=this.getTemplate(a.template||"default");if(b.extend(a,f),c=a.type,!(c in this.loaders)&&a.required)throw new Error("Unknown type ["+c+"] for required entity ["+d+"]");return e=new this.loaders[c](this.context,a),this.add(e),e},f.prototype.isLoading=function(){throw new Error("Not implemented")},f.prototype.find=function(a){for(var b=0;b<this.renderableEntities.length;b++)if(this.renderableEntities[b].id===a)return this.renderableEntities[b];for(var c=0;c<this.otherEntities.length;c++)if(this.otherEntities[c].id===a)return this.otherEntities[c];return null},f.prototype.add=function(a){this.fire("new.entity",a),a.isRenderable?(this.renderableEntities.push(a),this.resort()):this.otherEntities.push(a),this.fire("add.entity",a)},f.prototype.remove=function(a){var b=this.renderableEntities.indexOf(a);return~b?(this.renderableEntities.splice(b,1),this.fire("remove.entity",a),!0):(b=this.otherEntities.indexOf(a),~b?(this.otherEntities.splice(b,1),this.fire("remove.entity",a),!0):!1)},f.prototype.resort=function(){this.needsResort=!0},f.prototype.sortRenderables=function(){this.renderableEntities.sort(function(a,b){var c=a.getPosition(),d=b.getPosition();return c[2]<d[2]?-1:c[2]>d[2]?1:c[1]<d[1]?1:c[1]>d[1]?-1:0})},f.prototype.render=function(){this.needsResort&&(this.needsResort=!1,this.sortRenderables());for(var a=0;a<this.renderableEntities.length;a++)this.renderableEntities[a].visible&&this.renderableEntities[a].render()},f.prototype.isPathBlocked=function(a,b){return!1},f.prototype.isRectBlocked=function(a,b){for(var c=0;c<this.renderableEntities.length;c++)if(this.renderableEntities[c]!==b&&this.renderableEntities[c].collides(a))return!0;for(var d=0;d<this.otherEntities.length;d++)if(this.otherEntities[d]!==b&&this.otherEntities[d].collides(a))return!0;return!1},f}),define("Player",["Enum","Timer"],function(a,b){function c(a,c){this.networkBuffer="",this.context=a,this.onThink=this.onThink.bind(this),this.thinkTimer=new b(this.onThink,d),this.thinkTimer.start()}var d=50;return c.prototype.onThink=function(){this.checkInput()},c.prototype.checkInput=function(){var b,c,d,e,f=this.context.input,g=this.context.camera,h="",i=a.Direction.NONE;this.actor&&!this.actor.isMoving()&&f.hasFocus()&&(f.isKeyDown(window.KeyEvent.DOM_VK_PAGE_UP)?g.zoom>.2&&(g.zoom-=.1,g.updateTranslation()):f.isKeyDown(window.KeyEvent.DOM_VK_PAGE_DOWN)?g.zoom<2&&(g.zoom+=.1,g.updateTranslation()):f.isKeyDown(window.KeyEvent.DOM_VK_HOME)&&(g.zoom=1,g.updateTranslation()),b=f.isKeyDown(window.KeyEvent.DOM_VK_W)||f.isKeyDown(window.KeyEvent.DOM_VK_UP),d=f.isKeyDown(window.KeyEvent.DOM_VK_S)||f.isKeyDown(window.KeyEvent.DOM_VK_DOWN),e=f.isKeyDown(window.KeyEvent.DOM_VK_A)||f.isKeyDown(window.KeyEvent.DOM_VK_LEFT),c=f.isKeyDown(window.KeyEvent.DOM_VK_D)||f.isKeyDown(window.KeyEvent.DOM_VK_RIGHT),b?i=c?a.Direction.NORTHEAST:e?a.Direction.NORTHWEST:a.Direction.NORTH:d?i=c?a.Direction.SOUTHEAST:e?a.Direction.SOUTHWEST:a.Direction.SOUTH:c?i=a.Direction.EAST:e&&(i=a.Direction.WEST),i!==a.Direction.NONE&&(f.isKeyDown(window.KeyEvent.DOM_VK_C)||f.isKeyDown(window.KeyEvent.DOM_VK_CONTROL)?(this.actor.action!==a.Action.SIT||this.actor.direction!==i)&&(h+="s"+a.Direction.toChar(i)):this.actor.canMove(i)?(f.isKeyDown(window.KeyEvent.DOM_VK_SHIFT)?this.actor.speed!==a.Speed.RUN&&(h+="r"):this.actor.speed!==a.Speed.WALK&&(h+="w"),h+=a.Direction.toChar(i)):this.actor.direction!==i&&(h+="t"+a.Direction.toChar(i))),h.length>0&&(this.networkBuffer+=h,this.actor.addToActionBuffer(h)))},c}),define("Network",["EventHooks","Utility","entity/Actor"],function(a,b,c){function d(c,d){if(b.extend(this,a),this.context=c,this.server=d.server||null,this.token=d.token||null,this.room=d.room||null,this.clientId=null,this.server){this.socket=window.io(this.server);var e={connect:this.onConnect,disconnect:this.onDisconnect,error:this.onError,auth:this.onAuth};for(var f in e)e.hasOwnProperty(f)&&this.socket.on(f,e[f].bind(this))}}return d.prototype.onConnect=function(){this.socket.emit("auth",{token:this.token,room:this.room,name:"Chase"})},d.prototype.onDisconnect=function(){this.clientId=null},d.prototype.onError=function(a){window.alert(a.message),console.log(a)},d.prototype.onAuth=function(a){this.clientId=a.id,this.room=a.room},d.prototype.onJoin=function(a){var b;if(a.id===this.clientId){if(b=this.context.world.find(a.id),!(b instanceof c))throw new Error("Local actor does not exist");b.id=a.id,b.setName(a.name),b.setAvatar(a.avatar),b.setPosition(a.position),b.setAction(a.action),b.setDirection(a.direction)}else{if(b=this.context.world.find(a.id))throw new Error("Duplicate `join` for remote ["+a.id+"]");b=new c(this.context,{id:a.id,name:a.name,avatar:a.avatar,position:a.position,action:a.action,direction:a.direction}),this.context.world.add(b)}},d.prototype.onLeave=function(a){var b=this.context.world.find(a.id);if(!(b instanceof c))throw new Error("No Actor associated with remote ["+a.id+"]");b.destroy()},d.prototype.onSay=function(a){var b=this.context.world.find(a.id);if(!(b instanceof c))throw new Error("No Actor associated with remote ["+a.id+"]");b.say(a.message)},d.prototype.onMove=function(a){var b=this.context.world.find(a.id);if(!(b instanceof c))throw new Error("No Actor associated with remote ["+a.id+"]")},d}),define("plugins/Nametag",["entity/Entity","entity/Actor","resource/FontImage"],function(a,b,c){function d(b,c){a.call(this,b,c),this.isRenderable=!0,this.fontFamily=c.fontFamily||"sans-serif",this.fontColor=c.fontColor||"#000000",this.fontSize=c.fontSize||14,this.position[2]=f,this.updateText=this.updateText.bind(this),this.updatePosition=this.updatePosition.bind(this)}function e(a,b){this.context=a,this.options=b,this.onNewEntity=this.onNewEntity.bind(this),a.world.bind("add.entity",this.onNewEntity);for(var c=a.world.renderableEntities.length;c--;)this.onNewEntity(a.world.renderableEntities[c])}var f=998;return d.prototype=Object.create(a.prototype),d.prototype.constructor=d,d.prototype.setParent=function(b){a.prototype.setParent.call(this,b),b&&(b.bind("name.Nametag",this.updateText).bind("move.Nametag, avatar.Nametag",this.updatePosition),this.updateText(b.name),this.updatePosition())},d.prototype.updateText=function(){this.parent.name.length<1?this.visible=!1:(this.image=new c(this.context,{text:this.parent.name,fontFamily:this.fontFamily,fontColor:this.fontColor,fontSize:this.fontSize}),this.updatePosition())},d.prototype.updatePosition=function(){this.position[0]=0,this.position[1]=0,this.parent.avatar?this.position[1]=this.parent.avatar.height+10:this.position[1]=0,this.updateTranslation()},d.prototype.render=function(){this.image.render(this.translation,0)},d.prototype.getBoundingBox=function(a){a[0]=this.position[0],a[1]=this.position[1],a[2]=this.image.width,a[3]=this.image.height},e.prototype.onNewEntity=function(a){if(a instanceof b){var c=new d(this.context,this.options);this.context.world.add(c),a.addChild(c)}},e}),define("plugins/ChatBubble",["Utility","Timer","resource/Image","entity/Entity","entity/Actor"],function(a,b,c,d,e){function f(a,c){d.call(this,a,c),this.isRenderable=!0,this.text=c.text,this.ttl=c.ttl||j*Math.ceil(this.text.length/50),this.fontFamily=c.fontFamily||"sans-serif",this.fontColor=c.fontColor||"#000000",this.fontSize=c.fontSize||14,this.maxWidth=c.maxWidth||256,this.minWidth=c.minWidth||25,this.padding=c.padding||7,this.radius=c.radius||8,this.backgroundColor1=c.backgroundColor1||"#DDD",this.backgroundColor2=c.backgroundColor2||"#FFF",this.strokeWidth=c.strokeWidth||1.5,this.strokeColor1=c.strokeColor1||"#333",this.strokeColor2=c.strokecolor2||"#333",this.position[2]=i,this.updatePosition=this.updatePosition.bind(this),this.generateTexture(),this.destroy=this.destroy.bind(this),this.destroyTimer=new b(this.destroy,this.ttl),this.destroyTimer.start()}function g(a,b){this.context=a,this.options=b,this.onNewEntity=this.onNewEntity.bind(this),this.onSay=this.onSay.bind(this),a.world.bind("add.entity",this.onNewEntity);for(var c=0;c<a.world.renderableEntities.length;c++)this.onNewEntity(a.world.renderableEntities[c])}var h=document.createElement("canvas");document.querySelector("body").appendChild(h);var i=999,j=3e3;return f.prototype=Object.create(d.prototype),f.prototype.constructor=f,f.prototype.destroy=function(){this.destroyTimer&&this.destroyTimer.stop(),d.prototype.destroy.call(this)},f.prototype.generateTexture=function(){var b=h.getContext("2d"),d=this.text;if(d.length<1)throw new Error("No text");b.font=this.fontSize+"px "+this.fontFamily;var e,f,g,i=[];this.maxWidth&&b.measureText(d).width>this.maxWidth?(e=a.createMultilineText(b,d,this.maxWidth,i),e>this.maxWidth&&(e=this.maxWidth)):(i.push(d),e=Math.ceil(b.measureText(d).width)),f=this.fontSize*i.length,this.padding&&(f+=2*this.padding,e+=2*this.padding);var j=this.fontSize/2;f+=j,this.width=h.width=e,this.height=h.height=f,b.clearRect(0,0,e,f),e-=2*this.strokeWidth,f-=2*this.strokeWidth+j;var k=this.strokeWidth,l=k,m=k+e,n=l+f,o=k+e/2,p=this.radius;if(this.strokeColor1===this.strokeColor2)b.strokeStyle=this.strokeColor1;else{var q=b.createLinearGradient(0,0,0,f);q.addColorStop(0,this.strokeColor1),q.addColorStop(1,this.strokeColor2),b.strokeStyle=q}if(b.beginPath(),b.lineWidth=this.strokeWidth,b.moveTo(k+p,l),b.lineTo(m-p,l),b.quadraticCurveTo(m,l,m,l+p),b.lineTo(m,l+f-p),b.quadraticCurveTo(m,n,m-p,n),b.lineTo(o-4,n),b.lineTo(o-4,n+j),b.lineTo(Math.max(k+p,o-20),n),b.lineTo(k+p,n),b.quadraticCurveTo(k,n,k,n-p),b.lineTo(k,l+p),b.quadraticCurveTo(k,l,k+p,l),this.backgroundColor1===this.backgroundColor2)b.fillStyle=this.backgroundColor1;else{var r=b.createLinearGradient(0,0,0,f);r.addColorStop(0,this.backgroundColor1),r.addColorStop(1,this.backgroundColor2),b.fillStyle=r}b.fill(),b.stroke(),b.fillStyle=this.fontColor,b.textAlign="center",b.textBaseline="middle",b.font=this.fontSize+"px "+this.fontFamily;for(var s=this.padding+this.fontSize/2,t=0;t<i.length;t++)g=t*this.fontSize+s,b.fillText(i[t],o,g);this.image=new c(this.context,{type:"image",canvas:h,width:this.width,height:this.height})},f.prototype.setParent=function(a){d.prototype.setParent.call(this,a),a&&(a.bind("move.ChatBubble, avatar.ChatBubble",this.updatePosition),this.updatePosition())},f.prototype.updatePosition=function(){this.position[0]=0,this.position[1]=0,this.offset[1]=.5*this.height,this.parent&&this.parent.avatar?this.position[1]=this.parent.avatar.height+10:this.position[1]=0,this.updateTranslation()},f.prototype.render=function(){this.image.render(this.translation,0)},f.prototype.getBoundingBox=function(a){a[0]=this.position[0],a[1]=this.position[1],a[2]=this.image.width,a[3]=this.image.height},g.prototype.onNewEntity=function(a){a instanceof e&&a.bind("say",this.onSay)},g.prototype.onSay=function(b){var c={text:b.message};a.extend(c,this.options);var d=new f(this.context,c);this.context.world.add(d);for(var e=b.entity.children.length;e--;)b.entity.children[e]instanceof f&&b.entity.children[e].destroy();b.entity.addChild(d)},g}),define("fro",["Timer","Audio","Resources","Renderer","Camera","Input","World","Player","Network","plugins/Nametag","plugins/ChatBubble"],function(a,b,c,d,e,f,g,h,i,j,k){function l(a){this.options=a,this.plugins={},this.framerates=[],this.numFramerates=10,this.renderTime=-1,this.resources=new c(this),this.audio=new b(this,a.audio||{}),this.renderer=new d(this,a.renderer||{}),this.camera=new e(this,a.camera||{}),this.input=new f(this,a.input||{}),a.hasOwnProperty("world")&&(this.world=new g(this,a.world)),this.player=new h(this,a.player),a.hasOwnProperty("plugins")&&(a.plugins.hasOwnProperty("Nametag")&&(this.plugins.Nametag=new j(this,a.plugins.Nametag)),a.plugins.hasOwnProperty("ChatBubble")&&(this.plugins.ChatBubble=new k(this,a.plugins.ChatBubble))),a.hasOwnProperty("network")&&(this.network=i(this,a.network))}var m=1e3/30;return l.prototype.run=function(){this.lastTime=Date.now(),this.startTime=Date.now(),this.heartbeat()},l.prototype.heartbeat=function(){window.requestAnimationFrame(this.heartbeat.bind(this));var a=Date.now(),b=a-this.lastTime;b>m&&(this.render(),this.snapshot(),this.lastTime=a-b%m)},l.prototype.render=function(){this.camera.setupViewport(),this.world&&this.world.render()},l.prototype.snapshot=function(){if(this.renderTime<0)this.renderTime=(new Date).getTime();else{var a=(new Date).getTime(),b=a-this.renderTime;if(0===b)return;var c=1e3/b;for(this.framerates.push(c);this.framerates.length>this.numFramerates;)this.framerates.shift();this.renderTime=a}},l.prototype.getFramerate=function(){for(var a=0,b=0;b<this.framerates.length;++b)a+=this.framerates[b];var c=a/this.framerates.length;return c=Math.round(c)},l})}();
//# sourceMappingURL=fro.map