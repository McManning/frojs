/*! frojs 22-08-2015 */

!function(){define("EventHooks",[],function(){return{bind:function(a,b,c){if(null===b&&null===c)return this;"function"==typeof b&&(c=b,b=this);for(var d="",e=a.split(","),f=0;f<e.length;f++)a=e[f].trim(),a.indexOf(".")>=0&&(d=a.split("."),a=d.shift(),d.sort(),d=d.join(".")),"undefined"==typeof this._events?(this._events={},this._events[a]=[]):a in this._events||(this._events[a]=[]),this._events[a].push({callback:c,obj:b,namespaces:d});return this},unbind:function(a,b){var c;if(null===b&&("function"==typeof a?(b=a,a=void 0):null===a?(a=void 0,b=void 0):b=void 0),"undefined"!=typeof a){if(a in this._events)if("undefined"!=typeof b)for(c=this._events[a].length;c--;)this._events[a][c]===b&&this._events[a].splice(c,1);else delete this._events[a]}else if("undefined"!=typeof b){for(var d in this._events)if(this._events.hasOwnProperty(d))for(c=this._events[d].length;c--;)this._events[d][c]===b&&this._events[d].splice(c,1)}else this._events={};return this},fire:function(a,b){var c=null;if(~a.indexOf(".")){var d=a.split(".");a=d.shift(),d.length>0&&(d.sort(),c=new RegExp("(^|\\.)"+d.join("\\.(?:.*\\.|)")+"(\\.|$)"))}if("undefined"!=typeof this._events&&a in this._events)for(var e=0;e<this._events[a].length;e++){var f=this._events[a][e];if(!c||c.test(f.namespaces))try{f.callback.apply(f.obj,[b])}catch(g){throw new Error("Exception during event ["+a+"]: "+g.stack)}}}}}),define("glMatrix",[],function(){"undefined"!=typeof window.Float32Array?window.window.glMatrixArrayType=window.Float32Array:"undefined"!=typeof window.WebGLFloatArray?window.window.glMatrixArrayType=window.WebGLFloatArray:window.window.glMatrixArrayType=Array;var a={};a.create=function(a){var b=new window.glMatrixArrayType(4);return a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]),b},a.set=function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},a.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"},a.x2=function(a){return a[0]+a[2]},a.y2=function(a){return a[1]+a[3]},a.intersects=function(a,b){return!(b[0]>a[0]+a[2]||b[0]+b[2]<a[0]||b[1]>a[1]+a[3]||b[1]+b[3]<a[1])},a.intersection=function(a,b,c){c||(c=a);var d,e;return d=Math.max(a[0],b[0]),e=Math.max(a[1],b[1]),c[2]=Math.min(a[0]+a[2],b[0]+b[2])-d,c[3]=Math.min(a[1]+a[3],b[1]+b[3])-e,c};var b={};b.create=function(a){var b=new window.glMatrixArrayType(3);return a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2]),b},b.set=function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b},b.equals=function(a,b){return a[0]==b[0]&&a[1]==b[1]&&a[2]==b[2]},b.add=function(a,b,c){return c&&a!=c?(c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c):(a[0]+=b[0],a[1]+=b[1],a[2]+=b[2],a)},b.subtract=function(a,b,c){return c&&a!=c?(c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c):(a[0]-=b[0],a[1]-=b[1],a[2]-=b[2],a)},b.negate=function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b},b.scale=function(a,b,c){return c&&a!=c?(c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c):(a[0]*=b,a[1]*=b,a[2]*=b,a)},b.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=Math.sqrt(c*c+d*d+e*e);return f?1==f?(b[0]=c,b[1]=d,b[2]=e,b):(f=1/f,b[0]=c*f,b[1]=d*f,b[2]=e*f,b):(b[0]=0,b[1]=0,b[2]=0,b)},b.cross=function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},b.length=function(a){var b=a[0],c=a[1],d=a[2];return Math.sqrt(b*b+c*c+d*d)},b.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},b.direction=function(a,b,c){c||(c=a);var d=a[0]-b[0],e=a[1]-b[1],f=a[2]-b[2],g=Math.sqrt(d*d+e*e+f*f);return g?(g=1/g,c[0]=d*g,c[1]=e*g,c[2]=f*g,c):(c[0]=0,c[1]=0,c[2]=0,c)},b.lerp=function(a,b,c,d){return d||(d=a),d[0]=a[0]+c*(b[0]-a[0]),d[1]=a[1]+c*(b[1]-a[1]),d[2]=a[2]+c*(b[2]-a[2]),d},b.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+"]"};var c={};c.create=function(a){var b=new window.glMatrixArrayType(9);return a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8]),b},c.set=function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b},c.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},c.transpose=function(a,b){if(!b||a==b){var c=a[1],d=a[2],e=a[5];return a[1]=a[3],a[2]=a[6],a[3]=c,a[5]=a[7],a[6]=d,a[7]=e,a}return b[0]=a[0],b[1]=a[3],b[2]=a[6],b[3]=a[1],b[4]=a[4],b[5]=a[7],b[6]=a[2],b[7]=a[5],b[8]=a[8],b},c.toMat4=function(a,b){return b||(b=d.create()),b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=0,b[4]=a[3],b[5]=a[4],b[6]=a[5],b[7]=0,b[8]=a[6],b[9]=a[7],b[10]=a[8],b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,b},c.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+"]"};var d={};return d.create=function(a){var b=new window.glMatrixArrayType(16);return a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15]),b},d.set=function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b},d.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},d.transpose=function(a,b){if(!b||a==b){var c=a[1],d=a[2],e=a[3],f=a[6],g=a[7],h=a[11];return a[1]=a[4],a[2]=a[8],a[3]=a[12],a[4]=c,a[6]=a[9],a[7]=a[13],a[8]=d,a[9]=f,a[11]=a[14],a[12]=e,a[13]=g,a[14]=h,a}return b[0]=a[0],b[1]=a[4],b[2]=a[8],b[3]=a[12],b[4]=a[1],b[5]=a[5],b[6]=a[9],b[7]=a[13],b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=a[14],b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},d.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},d.inverse=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},d.toRotationMat=function(a,b){return b||(b=d.create()),b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=0,b[13]=0,b[14]=0,b[15]=1,b},d.toMat3=function(a,b){return b||(b=c.create()),b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[4],b[4]=a[5],b[5]=a[6],b[6]=a[8],b[7]=a[9],b[8]=a[10],b},d.toInverseMat3=function(a,b){var d=a[0],e=a[1],f=a[2],g=a[4],h=a[5],i=a[6],j=a[8],k=a[9],l=a[10],m=l*h-i*k,n=-l*g+i*j,o=k*g-h*j,p=d*m+e*n+f*o;if(!p)return null;var q=1/p;return b||(b=c.create()),b[0]=m*q,b[1]=(-l*e+f*k)*q,b[2]=(i*e-f*h)*q,b[3]=n*q,b[4]=(l*d-f*j)*q,b[5]=(-i*d+f*g)*q,b[6]=o*q,b[7]=(-k*d+e*j)*q,b[8]=(h*d-e*g)*q,b},d.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},d.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],f=b[2];return c[0]=a[0]*d+a[4]*e+a[8]*f+a[12],c[1]=a[1]*d+a[5]*e+a[9]*f+a[13],c[2]=a[2]*d+a[6]*e+a[10]*f+a[14],c},d.multiplyVec4=function(a,b,c){c||(c=b);var d=b[0],e=b[1],f=b[2],g=b[3];return c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*g,c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*g,c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*g,c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*g,c},d.translate=function(a,b,c){var d=b[0],e=b[1],f=b[2];if(!c||a==c)return a[12]=a[0]*d+a[4]*e+a[8]*f+a[12],a[13]=a[1]*d+a[5]*e+a[9]*f+a[13],a[14]=a[2]*d+a[6]*e+a[10]*f+a[14],a[15]=a[3]*d+a[7]*e+a[11]*f+a[15],a;var g=a[0],h=a[1],i=a[2],j=a[3],k=a[4],l=a[5],m=a[6],n=a[7],o=a[8],p=a[9],q=a[10],r=a[11];return c[0]=g,c[1]=h,c[2]=i,c[3]=j,c[4]=k,c[5]=l,c[6]=m,c[7]=n,c[8]=o,c[9]=p,c[10]=q,c[11]=r,c[12]=g*d+k*e+o*f+a[12],c[13]=h*d+l*e+p*f+a[13],c[14]=i*d+m*e+q*f+a[14],c[15]=j*d+n*e+r*f+a[15],c},d.scale=function(a,b,c){var d=b[0],e=b[1],f=b[2];return c&&a!=c?(c[0]=a[0]*d,c[1]=a[1]*d,c[2]=a[2]*d,c[3]=a[3]*d,c[4]=a[4]*e,c[5]=a[5]*e,c[6]=a[6]*e,c[7]=a[7]*e,c[8]=a[8]*f,c[9]=a[9]*f,c[10]=a[10]*f,c[11]=a[11]*f,c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15],c):(a[0]*=d,a[1]*=d,a[2]*=d,a[3]*=d,a[4]*=e,a[5]*=e,a[6]*=e,a[7]*=e,a[8]*=f,a[9]*=f,a[10]*=f,a[11]*=f,a)},d.rotate=function(a,b,c,d){var e=c[0],f=c[1],g=c[2],h=Math.sqrt(e*e+f*f+g*g);if(!h)return null;1!=h&&(h=1/h,e*=h,f*=h,g*=h);var i=Math.sin(b),j=Math.cos(b),k=1-j,l=a[0],m=a[1],n=a[2],o=a[3],p=a[4],q=a[5],r=a[6],s=a[7],t=a[8],u=a[9],v=a[10],w=a[11],x=e*e*k+j,y=f*e*k+g*i,z=g*e*k-f*i,A=e*f*k-g*i,B=f*f*k+j,C=g*f*k+e*i,D=e*g*k+f*i,E=f*g*k-e*i,F=g*g*k+j;return d?a!=d&&(d[12]=a[12],d[13]=a[13],d[14]=a[14],d[15]=a[15]):d=a,d[0]=l*x+p*y+t*z,d[1]=m*x+q*y+u*z,d[2]=n*x+r*y+v*z,d[3]=o*x+s*y+w*z,d[4]=l*A+p*B+t*C,d[5]=m*A+q*B+u*C,d[6]=n*A+r*B+v*C,d[7]=o*A+s*B+w*C,d[8]=l*D+p*E+t*F,d[9]=m*D+q*E+u*F,d[10]=n*D+r*E+v*F,d[11]=o*D+s*E+w*F,d},d.rotateX=function(a,b,c){var d=Math.sin(b),e=Math.cos(b),f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11];return c?a!=c&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a,c[4]=f*e+j*d,c[5]=g*e+k*d,c[6]=h*e+l*d,c[7]=i*e+m*d,c[8]=f*-d+j*e,c[9]=g*-d+k*e,c[10]=h*-d+l*e,c[11]=i*-d+m*e,c},d.rotateY=function(a,b,c){var d=Math.sin(b),e=Math.cos(b),f=a[0],g=a[1],h=a[2],i=a[3],j=a[8],k=a[9],l=a[10],m=a[11];return c?a!=c&&(c[4]=a[4],c[5]=a[5],c[6]=a[6],c[7]=a[7],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a,c[0]=f*e+j*-d,c[1]=g*e+k*-d,c[2]=h*e+l*-d,c[3]=i*e+m*-d,c[8]=f*d+j*e,c[9]=g*d+k*e,c[10]=h*d+l*e,c[11]=i*d+m*e,c},d.rotateZ=function(a,b,c){var d=Math.sin(b),e=Math.cos(b),f=a[0],g=a[1],h=a[2],i=a[3],j=a[4],k=a[5],l=a[6],m=a[7];return c?a!=c&&(c[8]=a[8],c[9]=a[9],c[10]=a[10],c[11]=a[11],c[12]=a[12],c[13]=a[13],c[14]=a[14],c[15]=a[15]):c=a,c[0]=f*e+j*d,c[1]=g*e+k*d,c[2]=h*e+l*d,c[3]=i*e+m*d,c[4]=f*-d+j*e,c[5]=g*-d+k*e,c[6]=h*-d+l*e,c[7]=i*-d+m*e,c},d.frustum=function(a,b,c,e,f,g,h){h||(h=d.create());var i=b-a,j=e-c,k=g-f;return h[0]=2*f/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2*f/j,h[6]=0,h[7]=0,h[8]=(b+a)/i,h[9]=(e+c)/j,h[10]=-(g+f)/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-(g*f*2)/k,h[15]=0,h},d.perspective=function(a,b,c,e,f){var g=c*Math.tan(a*Math.PI/360),h=g*b;return d.frustum(-h,h,-g,g,c,e,f)},d.ortho=function(a,b,c,e,f,g,h){h||(h=d.create());var i=b-a,j=e-c,k=g-f;return h[0]=2/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=2/j,h[6]=0,h[7]=0,h[8]=0,h[9]=0,h[10]=-2/k,h[11]=0,h[12]=-(a+b)/i,h[13]=-(e+c)/j,h[14]=-(g+f)/k,h[15]=1,h},d.lookAt=function(a,b,c,e){e||(e=d.create());var f=a[0],g=a[1],h=a[2],i=c[0],j=c[1],k=c[2],l=b[0],m=b[1],n=b[2];if(f==l&&g==m&&h==n)return d.identity(e);var o,p,q,r,s,t,u,v,w,x;return o=f-b[0],p=g-b[1],q=h-b[2],x=1/Math.sqrt(o*o+p*p+q*q),o*=x,p*=x,q*=x,r=j*q-k*p,s=k*o-i*q,t=i*p-j*o,x=Math.sqrt(r*r+s*s+t*t),x?(x=1/x,r*=x,s*=x,t*=x):(r=0,s=0,t=0),u=p*t-q*s,v=q*r-o*t,w=o*s-p*r,x=Math.sqrt(u*u+v*v+w*w),x?(x=1/x,u*=x,v*=x,w*=x):(u=0,v=0,w=0),e[0]=r,e[1]=u,e[2]=o,e[3]=0,e[4]=s,e[5]=v,e[6]=p,e[7]=0,e[8]=t,e[9]=w,e[10]=q,e[11]=0,e[12]=-(r*f+s*g+t*h),e[13]=-(u*f+v*g+w*h),e[14]=-(o*f+p*g+q*h),e[15]=1,e},d.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+"]"},quat4={},quat4.create=function(a){var b=new window.glMatrixArrayType(4);return a&&(b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3]),b},quat4.set=function(a,b){return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},quat4.calculateW=function(a,b){var c=a[0],d=a[1],e=a[2];return b&&a!=b?(b[0]=c,b[1]=d,b[2]=e,b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),b):(a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a)},quat4.inverse=function(a,b){return b&&a!=b?(b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=a[3],b):(a[0]*=-1,a[1]*=-1,a[2]*=-1,a)},quat4.length=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return Math.sqrt(b*b+c*c+d*d+e*e)},quat4.normalize=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=Math.sqrt(c*c+d*d+e*e+f*f);return 0==g?(b[0]=0,b[1]=0,b[2]=0,b[3]=0,b):(g=1/g,b[0]=c*g,b[1]=d*g,b[2]=e*g,b[3]=f*g,b)},quat4.multiply=function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=b[0],i=b[1],j=b[2],k=b[3];return c[0]=d*k+g*h+e*j-f*i,c[1]=e*k+g*i+f*h-d*j,c[2]=f*k+g*j+d*i-e*h,c[3]=g*k-d*h-e*i-f*j,c},quat4.multiplyVec3=function(a,b,c){c||(c=b);var d=b[0],e=b[1],f=b[2],g=a[0],h=a[1],i=a[2],j=a[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return c[0]=k*j+n*-g+l*-i-m*-h,c[1]=l*j+n*-h+m*-g-k*-i,c[2]=m*j+n*-i+k*-h-l*-g,c},quat4.toMat3=function(a,b){b||(b=c.create());var d=a[0],e=a[1],f=a[2],g=a[3],h=d+d,i=e+e,j=f+f,k=d*h,l=d*i,m=d*j,n=e*i,o=e*j,p=f*j,q=g*h,r=g*i,s=g*j;return b[0]=1-(n+p),b[1]=l-s,b[2]=m+r,b[3]=l+s,b[4]=1-(k+p),b[5]=o-q,b[6]=m-r,b[7]=o+q,b[8]=1-(k+n),b},quat4.toMat4=function(a,b){b||(b=d.create());var c=a[0],e=a[1],f=a[2],g=a[3],h=c+c,i=e+e,j=f+f,k=c*h,l=c*i,m=c*j,n=e*i,o=e*j,p=f*j,q=g*h,r=g*i,s=g*j;return b[0]=1-(n+p),b[1]=l-s,b[2]=m+r,b[3]=0,b[4]=l+s,b[5]=1-(k+p),b[6]=o-q,b[7]=0,b[8]=m-r,b[9]=o+q,b[10]=1-(k+n),b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,b},quat4.slerp=function(a,b,c,d){d||(d=a);var e=a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3];if(Math.abs(e)>=1)return d!=a&&(d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=a[3]),d;var f=Math.acos(e),g=Math.sqrt(1-e*e);if(Math.abs(g)<.001)return d[0]=.5*a[0]+.5*b[0],d[1]=.5*a[1]+.5*b[1],d[2]=.5*a[2]+.5*b[2],d[3]=.5*a[3]+.5*b[3],d;var h=Math.sin((1-c)*f)/g,i=Math.sin(c*f)/g;return d[0]=a[0]*h+b[0]*i,d[1]=a[1]*h+b[1]*i,d[2]=a[2]*h+b[2]*i,d[3]=a[3]*h+b[3]*i,d},quat4.str=function(a){return"["+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+"]"},{rect:a,vec3:b,mat3:c,mat4:d,quat4:quat4}}),define("Utility",["glMatrix"],function(a){var b={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return{rect:a.rect,vec3:a.vec3,mat3:a.mat3,mat4:a.mat4,quat4:a.quat4,escape:function(a){return String(a).replace(/[&<>"'\/]/g,function(a){return b[a]})},createMultilineText:function(a,b,c,d){b=b.replace("\n"," ");var e,f,g,h=b,i=0,j=0,k=b.split(" ");for(f=g=k.length;a.measureText(h).width>c&&f>1;){f--,h=e="";for(var l=0;g>l;l++)f>l?(h+=k[l],f>l+1&&(h+=" ")):(e+=k[l],g>l+1&&(e+=" "))}return d.push(h),j=Math.ceil(a.measureText(h).width),e&&(i=this.createMultilineText(a,e,c,d),i>j&&(j=i)),j},getBrowserReport:function(a,b){var c="";if(c+="\nBrowser Details\n",window.navigator){if(c+="* appName: "+window.navigator.appName+"\n",c+="* appVersion: "+window.navigator.appVersion+"\n",c+="* platform: "+window.navigator.platform+"\n",c+="* vendor: "+window.navigator.vendor+"\n",c+="* cookieEnabled: "+window.navigator.cookieEnabled+"\n",window.navigator.plugins&&a){c+="* Plugins\n";for(var d=0;d<window.navigator.plugins.length;d++){var e=window.navigator.plugins[d].name,f=window.navigator.plugins[d].filename;c+="** *"+e+"* - "+f+"\n"}}}else c+="* !window.navigator\n";if(c+="\nWebSocket Details\n",c+="WebSocket"in window?"* WebSocket object support\n":"MozWebSocket"in window?"* MozWebSocket object support\n":"* No WebSocket support\n",c+="\nWebGL Details\n",!b&&!window.gl){var g=document.createElement("canvas");"getContext"in g&&(b=g.getContext("webgl"),b||(b=g.getContext("experimental-webgl")))}if(b){c+="* VERSION: "+b.getParameter(b.VERSION)+"\n",c+="* VENDOR: "+b.getParameter(b.VENDOR)+"\n",c+="* RENDERER: "+b.getParameter(b.RENDERER)+"\n",c+="* SHADING_LANGUAGE_VERSION: "+b.getParameter(b.SHADING_LANGUAGE_VERSION)+"\n";var h=b.getParameter(b.CURRENT_PROGRAM);h&&(c+="* CURRENT_PROGRAM Log: "+b.getProgramInfoLog(b.getParameter(b.CURRENT_PROGRAM))+"\n")}else c+="* No support\n";return c},extend:function(a,b){return Object.keys(b).map(function(c){a.hasOwnProperty(c)||(a[c]=b[c])}),a},hash:function(a){var b,c,d=0,e=a.length;if(0===e)return d;for(b=0;e>b;++b)c=a.charCodeAt(b),d=(d<<5)-d+c,d&=d;return d}}}),define("Timer",[],function(){function a(a,b){this.callback=a,this.interval=b,this.running=!1}return a.prototype.tick=function(){if(this.running){var a=Date.now();for(this.callback(this,a-(this.planned-this.interval)),this.lastRun=this.planned,this.planned+=this.interval;this.planned<a;)this.callback(this,0),this.lastRun=this.planned,this.planned+=this.interval;this.timeout=window.setTimeout(this.tick.bind(this),this.planned-a)}},a.prototype.start=function(){this.running||(this.running=!0,this.planned=Date.now()+this.interval,this.lastRun=Date.now(),this.timeout=window.setTimeout(this.tick.bind(this),this.interval))},a.prototype.stop=function(){this.running&&(this.running=!1,window.clearTimeout(this.timeout))},a}),define("Audio",["EventHooks","Utility"],function(a,b){function c(c){b.extend(this,a),this.audioSupported=!0,this.audioContext=null,this.audioGainNode=null,this.ambientGainNode=null;try{window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext&&(this.audioContext=new window.AudioContext)}catch(d){this.audioSupported=!1}if(this.audioSupported){if(this.audioContext.createGain||(this.audioContext.createGain=this.audioContext.createGainNode),!this.audioContext.createGain)throw new Error("Failed to identify createGain() for audio context");this.audioGainNode=this.audioContext.createGain(),this.audioGainNode.connect(this.audioContext.destination),this.ambientGainNode=this.audioContext.createGain(),this.ambientGainNode.connect(this.audioGainNode)}}return c.prototype.isAvailable=function(){return null!==this.audioContext},c.prototype.getAudioContext=function(){return this.audioContext},c.prototype.setMasterVolume=function(a){a>1&&(a=1),this.audioContext&&this.audioGainNode&&(this.audioGainNode.gain.value=a*a,this.fire("setmaster",a))},c.prototype.getMasterVolume=function(){return this.audioContext&&this.audioGainNode?this.audioGainNode.gain.value:0},c.prototype.setAmbientVolume=function(a){a>1&&(a=1),this.audioContext&&this.audioGainNode&&(this.ambientGainNode.gain.value=a*a,this.fire("setambient",a))},c.prototype.getAmbientVolume=function(){return this.audioContext&&this.audioGainNode?this.ambientGainNode.gain.value:0},c.prototype.addConnection=function(a,b){this.audioContext&&(b?a.connect(this.ambientGainNode):a.connect(this.audioGainNode))},c.prototype.play=function(a){this.audioContext&&a.start(0)},c.prototype.stop=function(a){this.audioContext&&a.stop(0)},c}),define("Resources",["EventHooks","Utility"],function(a,b){function c(c){b.extend(this,a),this.context=c,this.loaded={},this.failed={},this.totalPreload=0,this.completedPreload=0,this.onPreloadResourceComplete=this.onPreloadResourceComplete.bind(this),this.onPreloadResourceError=this.onPreloadResourceError.bind(this)}return c.prototype.preload=function(a){if(this.totalPreload=0,this.completedPreload=0,a.hasOwnProperty("required")){this.totalPreload+=a.required.length;for(var b=0;b<a.required.length;b++)this._preloadResource(a.required[b])}return this},c.prototype.isPreloadComplete=function(){return this.totalPreload===this.completedPreload},c.prototype._preloadResource=function(a){var b=this.load(a);b.isLoaded()?this.onPreloadResourceComplete(b):b.bind("onload",this.onPreloadResourceComplete).bind("onerror",this.onPreloadResourceError)},c.prototype.onPreloadResourceComplete=function(a){this.completedPreload++,this.fire("preload.status",a),this.completedPreload===this.totalPreload&&this.fire("preload.complete")},c.prototype.onPreloadResourceError=function(a){this.failed[a._resourceId]=a,this.fire("preload.error",a)},c.prototype.isLoaded=function(a){return this.loaded.hasOwnProperty(a)},c.prototype.load=function(a){var c=require("fro");if(!a.hasOwnProperty("type"))throw new Error("JSON resource is missing required attribute [type]: "+JSON.stringify(a));var d=b.hash(JSON.stringify(a)),e=a.type;if(this.loaded.hasOwnProperty(d)&&this.loaded[d].shareable)return this.loaded[d];if(!c.resources.hasOwnProperty(e))throw this.failed[d]=a,new Error("Cannot load ["+d+"]. No loader for type ["+e+"]");var f=new c.resources[e](this.context,a);return f._resourceId=d,f.shareable&&(this.loaded[d]=f),f},c}),define("text",["module"],function(a){"use strict";var b,c,d,e,f,g=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],h=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,i=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,j="undefined"!=typeof location&&location.href,k=j&&location.protocol&&location.protocol.replace(/\:/,""),l=j&&location.hostname,m=j&&(location.port||void 0),n={},o=a.config&&a.config()||{};return b={version:"2.0.14",strip:function(a){if(a){a=a.replace(h,"");var b=a.match(i);b&&(a=b[1])}else a="";return a},jsEscape:function(a){return a.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:o.createXhr||function(){var a,b,c;if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject)for(b=0;3>b;b+=1){c=g[b];try{a=new ActiveXObject(c)}catch(d){}if(a){g=[c];break}}return a},parseName:function(a){var b,c,d,e=!1,f=a.lastIndexOf("."),g=0===a.indexOf("./")||0===a.indexOf("../");return-1!==f&&(!g||f>1)?(b=a.substring(0,f),c=a.substring(f+1)):b=a,d=c||b,f=d.indexOf("!"),-1!==f&&(e="strip"===d.substring(f+1),d=d.substring(0,f),c?c=d:b=d),{moduleName:b,ext:c,strip:e}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(a,c,d,e){var f,g,h,i=b.xdRegExp.exec(a);return i?(f=i[2],g=i[3],g=g.split(":"),h=g[1],g=g[0],!(f&&f!==c||g&&g.toLowerCase()!==d.toLowerCase()||(h||g)&&h!==e)):!0},finishLoad:function(a,c,d,e){d=c?b.strip(d):d,o.isBuild&&(n[a]=d),e(d)},load:function(a,c,d,e){if(e&&e.isBuild&&!e.inlineText)return void d();o.isBuild=e&&e.isBuild;var f=b.parseName(a),g=f.moduleName+(f.ext?"."+f.ext:""),h=c.toUrl(g),i=o.useXhr||b.useXhr;return 0===h.indexOf("empty:")?void d():void(!j||i(h,k,l,m)?b.get(h,function(c){b.finishLoad(a,f.strip,c,d)},function(a){d.error&&d.error(a)}):c([g],function(a){b.finishLoad(f.moduleName+"."+f.ext,f.strip,a,d)}))},write:function(a,c,d,e){if(n.hasOwnProperty(c)){var f=b.jsEscape(n[c]);d.asModule(a+"!"+c,"define(function () { return '"+f+"';});\n")}},writeFile:function(a,c,d,e,f){var g=b.parseName(c),h=g.ext?"."+g.ext:"",i=g.moduleName+h,j=d.toUrl(g.moduleName+h)+".js";b.load(i,d,function(c){var d=function(a){return e(j,a)};d.asModule=function(a,b){return e.asModule(a,j,b)},b.write(a,i,d,f)},f)}},"node"===o.env||!o.env&&"undefined"!=typeof process&&process.versions&&process.versions.node&&!process.versions["node-webkit"]&&!process.versions["atom-shell"]?(c=require.nodeRequire("fs"),b.get=function(a,b,d){try{var e=c.readFileSync(a,"utf8");"\ufeff"===e[0]&&(e=e.substring(1)),b(e)}catch(f){d&&d(f)}}):"xhr"===o.env||!o.env&&b.createXhr()?b.get=function(a,c,d,e){var f,g=b.createXhr();if(g.open("GET",a,!0),e)for(f in e)e.hasOwnProperty(f)&&g.setRequestHeader(f.toLowerCase(),e[f]);o.onXhr&&o.onXhr(g,a),g.onreadystatechange=function(b){var e,f;4===g.readyState&&(e=g.status||0,e>399&&600>e?(f=new Error(a+" HTTP status: "+e),f.xhr=g,d&&d(f)):c(g.responseText),o.onXhrComplete&&o.onXhrComplete(g,a))},g.send(null)}:"rhino"===o.env||!o.env&&"undefined"!=typeof Packages&&"undefined"!=typeof java?b.get=function(a,b){var c,d,e="utf-8",f=new java.io.File(a),g=java.lang.System.getProperty("line.separator"),h=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(f),e)),i="";try{for(c=new java.lang.StringBuffer,d=h.readLine(),d&&d.length()&&65279===d.charAt(0)&&(d=d.substring(1)),null!==d&&c.append(d);null!==(d=h.readLine());)c.append(g),c.append(d);i=String(c.toString())}finally{h.close()}b(i)}:("xpconnect"===o.env||!o.env&&"undefined"!=typeof Components&&Components.classes&&Components.interfaces)&&(d=Components.classes,e=Components.interfaces,Components.utils["import"]("resource://gre/modules/FileUtils.jsm"),f="@mozilla.org/windows-registry-key;1"in d,b.get=function(a,b){var c,g,h,i={};f&&(a=a.replace(/\//g,"\\")),h=new FileUtils.File(a);try{c=d["@mozilla.org/network/file-input-stream;1"].createInstance(e.nsIFileInputStream),c.init(h,1,0,!1),g=d["@mozilla.org/intl/converter-input-stream;1"].createInstance(e.nsIConverterInputStream),g.init(c,"utf-8",c.available(),e.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER),g.readString(c.available(),i),g.close(),c.close(),b(i.value)}catch(j){throw new Error((h&&h.path||"")+": "+j)}}),b}),define("text!shaders/main.vs",[],function(){return"\r\nattribute vec3 aVertexPosition;\r\nattribute vec2 aTextureCoord;\r\n\r\nuniform mat4 uMVMatrix;\r\nuniform mat4 uPMatrix;\r\nuniform vec4 uColor;\r\n\r\nvarying vec2 vTextureCoord;\r\nvarying vec4 vWorldCoord;\r\n\r\nvoid main(void) {\r\n    \r\n    vWorldCoord = uMVMatrix * vec4(aVertexPosition, 1.0);\r\n    vTextureCoord = aTextureCoord;\r\n\r\n    gl_Position = uPMatrix * vWorldCoord * vec4(1, -1, 0, 1);\r\n\r\n    /*\r\n        gl_Position is absolute screen position [0, 1] (ie: @ screen x = 800, gl_Position.x = 1)\r\n        uMVMatrix * aVertexPos = is screen position in pixels (ie: x = (0, 800))\r\n        aVertexPos = [0, 1], where 0 is the left edge of the object rendered\r\n        gl_FragCoord (frag) = screen position, therefore same as uMVMatrix * aVertexPos?\r\n    */\r\n}\r\n"}),define("text!shaders/main.fs",[],function(){return"precision mediump float;\r\n\r\nvarying vec2 vTextureCoord;\r\nvarying vec4 vWorldCoord;\r\n\r\nuniform sampler2D uSampler;\r\nuniform vec2 uClip;\r\nuniform float uTime;\r\nuniform vec3 uCamera;\r\n\r\nvoid main(void) {\r\n    gl_FragColor = texture2D(uSampler, vTextureCoord + uClip);\r\n}\r\n"}),define("Renderer",["Utility","text!shaders/main.vs","text!shaders/main.fs"],function(a,b,c){function d(a,d){if(this.canvas=d.canvas,this.usesWebGL=!0,this.shaders=[],this.currentShader=null,this.clearStyle="rgb(0,0,0)",this.gl=null,!this.canvas)throw new Error("No canvas specified");try{var f=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl");this.gl=f,this.usesWebGL=!0}catch(g){this.usesWebGL=!1}if(!this.gl)throw new Error("No WebGL support");this.gl.viewportWidth=this.canvas.width,this.gl.viewportHeight=this.canvas.height,this.gl.mvMatrix=e.create(),this.gl.pMatrix=e.create(),this.gl.mvMatrixStack=[],this.gl.mvPopMatrix=function(){if(0===this.mvMatrixStack.length)throw new Error("Invalid popMatrix!");this.mvMatrix=this.mvMatrixStack.pop()},this.gl.mvPushMatrix=function(){var a=e.create();e.set(this.mvMatrix,a),this.mvMatrixStack.push(a)};var h=this;this.gl.setMatrixUniforms=function(){var a=h.getCurrentShader();this.uniformMatrix4fv(a.getUniform("uPMatrix"),!1,this.pMatrix),this.uniformMatrix4fv(a.getUniform("uMVMatrix"),!1,this.mvMatrix)},this.gl.enable(this.gl.BLEND),this.gl.blendFuncSeparate(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA,this.gl.ONE,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.clearColor(0,0,0,1),d.hasOwnProperty("background")&&this.setClearColor(d.background),a.renderer=this,this.defaultShader=a.resources.load({id:"shader:default",type:"Shader",vertex:b,fragment:c,uniforms:["uTime","uCamera","uClip","uSampler","uMVMatrix","uPMatrix"],attributes:["aVertexPosition","aTextureCoord"]})}var e=a.mat4;return d.prototype.isWebGL=function(){return this.usesWebGL===!0},d.prototype.getGLContext=function(){return this.gl},d.prototype.getCanvas=function(){return this.canvas},d.prototype.clear=function(){if(!this.isWebGL())throw new Error("Not supported");this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)},d.prototype.createTexture=function(a){var b,c=this.gl;if(!this.isWebGL())throw new Error("Not supported");return b=c.createTexture(),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),c.bindTexture(c.TEXTURE_2D,b),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.NEAREST),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR),c.bindTexture(c.TEXTURE_2D,null),b},d.prototype.setClearColor=function(a){this.clearStyle="rgb("+a[0]+","+a[1]+","+a[2]+")",this.isWebGL()&&this.gl.clearColor(a[0]/255,a[1]/255,a[2]/255,1)},d.prototype.useShader=function(a){a||(a=this.getDefaultShader()),this.currentShader=a,this.gl.useProgram(a.getProgram())},d.prototype.attachShader=function(a){this.shaders[a.id]=a},d.prototype.getCurrentShader=function(){return this.currentShader},d.prototype.getShader=function(a){if(!this.shaders.hasOwnProperty(a))throw new Error("Shader ["+a+"] is not loaded");return this.shaders[a]},d.prototype.getDefaultShader=function(){return this.defaultShader},d.prototype.setDefaultShader=function(a){this.defaultShader=a},d}),define("Camera",["EventHooks","Utility"],function(a,b){function c(c,f){b.extend(this,a),this.trackedEntity=null,this.position=f.position||d.create(),this.zoom=1,this.lastTrackedPosition=d.create(),this.translation=d.create(),this.bounds=e.create(),this.context=c,f.trackPlayer===!0&&(this.trackedEntity=this.context.player),f.hasOwnProperty("bounds")&&this.setBounds(f.bounds),this.updateTranslation()}var d=b.vec3,e=b.rect,f=b.mat4;return c.prototype.setupViewport=function(){var a=this.context.renderer.getGLContext();this.update(),(a.canvas.width!==a.canvas.clientWidth||a.canvas.height!==a.canvas.clientHeight)&&(a.canvas.width=a.canvas.clientWidth,a.canvas.height=a.canvas.clientHeight,a.viewportWidth=2*Math.round(.5*a.canvas.width),a.viewportHeight=2*Math.round(.5*a.canvas.height),this.applyBounds(),this.updateTranslation()),this.context.renderer.isWebGL()?(a.viewport(0,0,a.viewportWidth,a.viewportHeight),f.ortho(0,a.viewportWidth*this.zoom,0,a.viewportHeight*this.zoom,0,-1e3,a.pMatrix),f.identity(a.mvMatrix)):a.setTransform(1,0,0,1,0,0),f.translate(a.mvMatrix,this.translation),this.context.renderer.clear()},c.prototype.setBounds=function(a){e.set(a,this.bounds)},c.prototype.trackEntity=function(a){if("function"!=typeof a.getPosition)throw"Followed entity must have a getPosition() method.";this.trackedEntity=a,this.fire("follow",a)},c.prototype.getTrackedEntity=function(){return this.trackedEntity},c.prototype.updateTranslation=function(){var a=this.context.renderer.getGLContext();this.translation[0]=a.viewportWidth*this.zoom*.5-this.position[0],this.translation[1]=a.viewportHeight*this.zoom*.5-this.position[1]},c.prototype.setCenter=function(a){this.trackedEntity=null,this.position[0]=a[0],this.position[1]=a[1],this.applyBounds(),this.updateTranslation(),this.fire("move",this.position)},c.prototype.getCenter=function(){return this.position},c.prototype.update=function(){if(this.trackedEntity){var a=this.trackedEntity.getPosition();a[2]=0,d.equals(this.lastTrackedPosition,a)||(d.set(a,this.lastTrackedPosition),d.set(a,this.position),this.applyBounds(),this.updateTranslation(),this.fire("move",this.position))}},c.prototype.canvasVec3ToWorld=function(a){var b=this.context.renderer.getGLContext();a[0]=Math.floor((a[0]-.5*b.viewportWidth)*this.zoom+this.position[0]),a[1]=Math.floor((a[1]-.5*b.viewportHeight)*this.zoom+this.position[1])},c.prototype.applyBounds=function(){var a=this.context.renderer.getGLContext();if(this.bounds[0]!==this.bounds[2]&&this.bounds[1]!==this.bounds[3]){
var b=a.viewportWidth*this.zoom,c=a.viewportHeight*this.zoom,d=this.position[0]-.5*b,e=this.position[1]-.5*c;d<this.bounds[0]&&(d=this.bounds[0]),d+b>=this.bounds[2]&&(d=this.bounds[2]-b),e<this.bounds[1]&&(e=this.bounds[1]),e+c>=this.bounds[3]&&(e=this.bounds[3]-c),this.position[0]=d+.5*b,this.position[1]=e+.5*c}},c}),define("Input",["EventHooks","Utility"],function(a,b){function c(c,e){b.extend(this,a),this.pressedKeys=[],this.cursorPosition=d.create(),this.context=c,this.canvasFocus=!1;var f=c.renderer.getCanvas();f.setAttribute("tabindex",-1),this.onCanvasFocus=this.onCanvasFocus.bind(this),this.onCanvasBlur=this.onCanvasBlur.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onKeyUp=this.onKeyUp.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.onWindowFocus=this.onWindowFocus.bind(this),this.onWindowBlur=this.onWindowBlur.bind(this),f.addEventListener("mousedown",this.onMouseDown),f.addEventListener("focus",this.onCanvasFocus),f.addEventListener("blur",this.onCanvasBlur),document.addEventListener("mouseup",this.onMouseUp),document.addEventListener("mousemove",this.onMouseMove),window.addEventListener("keyup",this.onKeyUp),window.addEventListener("keydown",this.onKeyDown),window.onfocus=this.onWindowFocus,window.onblur=this.onWindowBlur}var d=b.vec3;return"undefined"==typeof window.KeyEvent&&(window.KeyEvent={DOM_VK_CANCEL:3,DOM_VK_HELP:6,DOM_VK_BACK_SPACE:8,DOM_VK_TAB:9,DOM_VK_CLEAR:12,DOM_VK_RETURN:13,DOM_VK_ENTER:14,DOM_VK_SHIFT:16,DOM_VK_CONTROL:17,DOM_VK_ALT:18,DOM_VK_PAUSE:19,DOM_VK_CAPS_LOCK:20,DOM_VK_ESCAPE:27,DOM_VK_SPACE:32,DOM_VK_PAGE_UP:33,DOM_VK_PAGE_DOWN:34,DOM_VK_END:35,DOM_VK_HOME:36,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_PRINTSCREEN:44,DOM_VK_INSERT:45,DOM_VK_DELETE:46,DOM_VK_0:48,DOM_VK_1:49,DOM_VK_2:50,DOM_VK_3:51,DOM_VK_4:52,DOM_VK_5:53,DOM_VK_6:54,DOM_VK_7:55,DOM_VK_8:56,DOM_VK_9:57,DOM_VK_SEMICOLON:59,DOM_VK_EQUALS:61,DOM_VK_A:65,DOM_VK_B:66,DOM_VK_C:67,DOM_VK_D:68,DOM_VK_E:69,DOM_VK_F:70,DOM_VK_G:71,DOM_VK_H:72,DOM_VK_I:73,DOM_VK_J:74,DOM_VK_K:75,DOM_VK_L:76,DOM_VK_M:77,DOM_VK_N:78,DOM_VK_O:79,DOM_VK_P:80,DOM_VK_Q:81,DOM_VK_R:82,DOM_VK_S:83,DOM_VK_T:84,DOM_VK_U:85,DOM_VK_V:86,DOM_VK_W:87,DOM_VK_X:88,DOM_VK_Y:89,DOM_VK_Z:90,DOM_VK_CONTEXT_MENU:93,DOM_VK_NUMPAD0:96,DOM_VK_NUMPAD1:97,DOM_VK_NUMPAD2:98,DOM_VK_NUMPAD3:99,DOM_VK_NUMPAD4:100,DOM_VK_NUMPAD5:101,DOM_VK_NUMPAD6:102,DOM_VK_NUMPAD7:103,DOM_VK_NUMPAD8:104,DOM_VK_NUMPAD9:105,DOM_VK_MULTIPLY:106,DOM_VK_ADD:107,DOM_VK_SEPARATOR:108,DOM_VK_SUBTRACT:109,DOM_VK_DECIMAL:110,DOM_VK_DIVIDE:111,DOM_VK_F1:112,DOM_VK_F2:113,DOM_VK_F3:114,DOM_VK_F4:115,DOM_VK_F5:116,DOM_VK_F6:117,DOM_VK_F7:118,DOM_VK_F8:119,DOM_VK_F9:120,DOM_VK_F10:121,DOM_VK_F11:122,DOM_VK_F12:123,DOM_VK_F13:124,DOM_VK_F14:125,DOM_VK_F15:126,DOM_VK_F16:127,DOM_VK_F17:128,DOM_VK_F18:129,DOM_VK_F19:130,DOM_VK_F20:131,DOM_VK_F21:132,DOM_VK_F22:133,DOM_VK_F23:134,DOM_VK_F24:135,DOM_VK_NUM_LOCK:144,DOM_VK_SCROLL_LOCK:145,DOM_VK_COMMA:188,DOM_VK_PERIOD:190,DOM_VK_SLASH:191,DOM_VK_BACK_QUOTE:192,DOM_VK_OPEN_BRACKET:219,DOM_VK_BACK_SLASH:220,DOM_VK_CLOSE_BRACKET:221,DOM_VK_QUOTE:222,DOM_VK_META:224}),c.prototype.onKeyDown=function(a){return a=a||window.event,this.pressedKeys[a.keyCode]=!0,this.fire("keydown",a),a.keyCode===window.KeyEvent.DOM_VK_PAGE_UP||a.keyCode===window.KeyEvent.DOM_VK_PAGE_DOWN?!1:void 0},c.prototype.onKeyUp=function(a){a=a||window.event,this.pressedKeys[a.keyCode]=!1,this.fire("keyup",a)},c.prototype.onMouseDown=function(a){a=a||window.event,this.updateCursorPosition(a),this.fire("mousedown",a)},c.prototype.onMouseUp=function(a){a=a||window.event,this.updateCursorPosition(a),this.fire("mouseup",a)},c.prototype.onMouseMove=function(a){a=a||window.event,this.updateCursorPosition(a)},c.prototype.updateCursorPosition=function(a){var b=this.context.renderer.getCanvas(),c=b.getBoundingClientRect();this.cursorPosition[0]=a.clientX-c.left,this.cursorPosition[1]=a.clientY-c.top},c.prototype.onCanvasBlur=function(){this.pressedKeys.length=0,this.canvasFocus=!1,this.fire("canvasblur")},c.prototype.onCanvasFocus=function(){this.canvasFocus=!0,this.fire("canvasfocus")},c.prototype.onWindowBlur=function(){this.pressedKeys.length=0,this.canvasFocus=!1,this.fire("windowblur")},c.prototype.onWindowFocus=function(){this.fire("windowfocus")},c.prototype.isKeyDown=function(a){return this.pressedKeys[a]===!0},c.prototype.hasFocus=function(){return this.canvasFocus},c.prototype.getCursorPosition=function(){return d.create(this.cursorPosition)},c}),define("Enum",["Utility"],function(a){var b=a.vec3,c={Direction:{NONE:0,NORTH:8,SOUTH:2,EAST:6,WEST:4,NORTHEAST:9,NORTHWEST:7,SOUTHEAST:3,SOUTHWEST:1,toChar:function(a){return a>0&&10>a?a.toString():"0"},fromChar:function(a){var b=parseInt(a);return b>0&&10>b?b:this.NONE},toVec3:function(a){var c=[0,0];switch(a){case this.NORTH:c=[0,-1];break;case this.NORTHEAST:c=[1,-1];break;case this.NORTHWEST:c=[-1,-1];break;case this.SOUTH:c=[0,1];break;case this.SOUTHEAST:c=[1,1];break;case this.SOUTHWEST:c=[-1,1];break;case this.EAST:c=[1,0];break;case this.WEST:c=[-1,0]}return c[2]=0,b.create(c)},fromVec3:function(a){var d=b.create(),e=this.NONE;return b.normalize(a,d),d[1]<0?e=d[0]>0?c.Direction.NORTHEAST:d[0]<0?c.Direction.NORTHWEST:c.Direction.NORTH:d[1]>0?e=d[0]>0?c.Direction.SOUTHEAST:d[0]<0?c.Direction.SOUTHWEST:c.Direction.SOUTH:d[0]>0?e=c.Direction.EAST:d[0]<0&&(e=c.Direction.WEST),e}},Speed:{WALK:4,RUN:8},Action:{IDLE:0,MOVE:1,SIT:2,JUMP:3}};return Object.freeze&&Object.freeze(c),c}),define("entity/Entity",["EventHooks","Utility"],function(a,b){function c(c,e){b.extend(this,a),this.id=e.id||null,this.isRenderable=!1,this.visible=!0,this.position=d.create(),this.offset=d.create(),this.translation=d.create(),this.context=c,this.children=[],this.parent=null}var d=b.vec3;return c.prototype.destroy=function(){if(this.fire("destroy"),this.parent&&this.parent.removeChild(this),this.children)for(var a=0;a<this.children.length;a++)this.children[a].setParent(null),this.children[a].destroy();this.context.remove(this)},c.prototype.addChild=function(a){this.children.push(a),a.setParent(this),this.fire("add",a)},c.prototype.removeChild=function(a){var b=this.children.indexOf(a);~b&&(this.children.splice(b,1),a.setParent(null),this.fire("remove",a))},c.prototype.setParent=function(a){this.parent=a,this.fire("parent",a)},c.prototype.getPosition=function(){return d.create(this.position)},c.prototype.getWorldPosition=function(){var a=this.getPosition();return this.parent&&d.add(a,this.parent.getWorldPosition()),a},c.prototype.setPosition=function(a){this.position[0]=Math.floor(a[0]),this.position[1]=Math.floor(a[1]),a.length>2&&(this.position[2]=Math.floor(a[2])),this.updateTranslation()},c.prototype.getOffset=function(){return this.offset},c.prototype.setOffset=function(a){this.offset[0]=Math.floor(a[0]),this.offset[1]=Math.floor(a[1]),this.updateTranslation()},c.prototype.getBoundingBox=function(a){a[0]=0,a[1]=0,a[2]=0,a[3]=0},c.prototype.getRenderable=function(){return this.isRenderable},c.prototype.setRenderable=function(a){this.isRenderable=a},c.prototype.updateTranslation=function(){var a=this.getWorldPosition();if(d.subtract(a,this.offset),!d.equals(a,this.translation)){d.set(a,this.translation);for(var b=0;b<this.children.length;b++)this.children[b].updateTranslation()}},c.prototype.collides=function(a){},c}),define("resource/Resource",["EventHooks","Utility"],function(a,b){function c(c,d){if(b.extend(this,a),!this.validateMetadata(d))throw new Error("Malformed resource metadata");this.shareable=!0,this.context=c,this.properties=d}return c.prototype.isLoaded=function(){throw Error("Method must be implemented by an inherited resource type.")},c.prototype.validateMetadata=function(a){throw Error("Method must be implemetned by an inherited resource type.")},c}),define("resource/Animation",["resource/Resource","Utility","Timer"],function(a,b,c){function d(b,d){a.call(this,b,d),this.shareable=!1,this.url=d.url,this.width=d.width,this.height=d.height,this.autoplay=!!d.autoplay,this.keyframes=d.keyframes,this.clip=e.create(),this.keyframe=null,this.setKeyframe(),this.image=b.resources.load({type:"Image",url:d.url,width:d.width,height:d.height,shader:d.shader,fitToTexture:!1}),this.onTimer=this.onTimer.bind(this),this.animateTimer=new c(this.onTimer,this.delay),this.onImageReady=this.onImageReady.bind(this),this.onImageError=this.onImageError.bind(this),this.image.isLoaded()?this.onImageReady():(this.image.bind("onload",this.onImageReady),this.image.bind("onerror",this.onImageError))}var e=b.rect,f=100;return d.prototype=Object.create(a.prototype),d.prototype.constructor=d,d.prototype.validateMetadata=function(a){for(var b=["width","height","url","keyframes"],c=0;c<b.length;c++)if(!a.hasOwnProperty(b[c]))return!1;return!0},d.prototype.next=function(a){this.keyframes.hasOwnProperty(this.keyframe)||this.setKeyframe(),this.keyframes[this.keyframe].frames.length<=this.index+1&&(this.keyframes[this.keyframe].loop||a?this.index=0:this.index-=2),this.frame=this.keyframes[this.keyframe].frames[this.index],this.delay=this.keyframes[this.keyframe].frames[this.index+1],this.delay=Math.max(this.delay,f),this.index+=2,this.updateTextureClip()},d.prototype.setKeyframe=function(a){this.keyframe!==a&&(a&&this.keyframes.hasOwnProperty(a)?(this.keyframe=a,this.reset()):this.keyframe=Object.keys(this.keyframes)[0])},d.prototype.hasKeyframe=function(a){return this.keyframes.hasOwnProperty(a)},d.prototype.reset=function(){this.index=0,this.frame=0,this.next(!1)},d.prototype.updateTextureClip=function(){if(this.image){var a=Math.floor(this.image.getTextureWidth()/this.width),b=this.frame%a,c=(this.frame-b)/a;this.clip[0]=b*this.width,this.clip[1]=c*this.height}},d.prototype.isLoaded=function(){return this.image.isLoaded()},d.prototype.onImageReady=function(){this.reset(),this.autoplay&&this.play(),this.fire("onload",this)},d.prototype.onImageError=function(){this.fire("onerror",this)},d.prototype.render=function(a){this.image&&this.image.render(a,0,this.clip)},d.prototype.onTimer=function(a){this.next(!1),a.interval=this.delay},d.prototype.play=function(){this.animateTimer.interval=this.delay,this.animateTimer.start()},d.prototype.stop=function(){this.animateTimer.stop()},d.prototype.isPlaying=function(){return this.animateTimer.running},d}),define("entity/Actor",["Enum","Utility","Timer","entity/Entity","resource/Animation"],function(a,b,c,d,e){function f(b,e){d.call(this,b,e),this.isRenderable=!0,this.step=0,this.name="",this.action=e.action||a.Action.IDLE,this.speed=e.speed||a.Speed.WALK,this.direction=e.direction||a.Direction.SOUTH,this.buffer="",this.destination=g.create(),this.directionNormal=g.create(),this.setPosition(e.position||[0,0,0]),this.setName(e.name||""),this.onThink=this.onThink.bind(this),this.thinkTimer=new c(this.onThink,j),this.thinkTimer.start(),e.hasOwnProperty("avatar")&&Object.keys(e.avatar).length>0&&this.setAvatar(e.avatar)}var g=b.vec3,h=b.rect,i=16,j=50;return f.prototype=Object.create(d.prototype),f.prototype.constructor=f,f.prototype.destroy=function(){this.thinkTimer&&this.thinkTimer.stop(),d.prototype.destroy.call(this)},f.prototype.setName=function(a){this.name=a,this.fire("name",this)},f.prototype.setAvatar=function(a){var b=this.context.resources.load(a);if(console.log("Set Avatar for "+this.name),b.isLoaded())this.setAvatarFromResource(b);else{var c=this;b.bind("onload",function(){c.setAvatarFromResource(b)}).bind("onerror",function(){throw new Error("Failed to load prop image for ["+c.id+"]")})}},f.prototype.setAvatarFromResource=function(a){this.avatar=a,this.offset[0]=.5*this.avatar.width,this.offset[1]=this.avatar.height,this.updateTranslation(),this.recalculateAvatarRow(),this.fire("avatar",this)},f.prototype.addToActionBuffer=function(a){this.fire("add.buffer",a),this.buffer+=a},f.prototype.say=function(a){this.fire("say",{entity:this,message:a})},f.prototype.render=function(){this.avatar&&this.avatar.render(this.translation,0)},f.prototype.canMove=function(b){var c=a.Direction.toVec3(b);g.scale(c,i);var d=h.create([this.position[0]+c[0]-4,this.position[1]+c[1]-8,8,8]);return!this.context.isRectBlocked(d,this)},f.prototype.isMoving=function(){var a=this.getPosition();return a[0]!==this.destination[0]||a[1]!==this.destination[1]},f.prototype.getBoundingBox=function(a){var b=this.position;this.avatar?(a[0]=b[0]-this.offset[0],a[1]=b[1]-this.offset[1],a[2]=this.avatar.width,a[3]=this.avatar.height):(a[0]=b[0]-this.offset[0],a[1]=b[1]-this.offset[1],a[2]=0,a[3]=0)},f.prototype.setPosition=function(a){d.prototype.setPosition.call(this,a),g.set(this.position,this.destination),this.fire("move",this.position)},f.prototype.setDestination=function(a){this.destination[0]=Math.floor(a[0]),this.destination[1]=Math.floor(a[1])},f.prototype.setAction=function(a){this.action=a,this.recalculateAvatarRow()},f.prototype.setSpeed=function(a){this.speed=a},f.prototype.setDirection=function(a){this.direction=a,this.recalculateAvatarRow()},f.prototype.setState=function(a){if(!Array.isArray(a)||a.length<5)throw Error("Invalid 5-tuple for Actor.setState()");this.setPosition(a.splice(0,3)),this.setDirection(a[0]),this.setAction(a[1])},f.prototype.getState=function(){return[this.position[0],this.position[1],this.position[2],this.direction,this.action]},f.prototype.onThink=function(){this.isMoving()||this.processActionBuffer(),this.isMoving()?(this.avatar instanceof e&&this.avatar.stop(),this.processMovement()):this.action===a.Action.MOVE&&(this.setAction(a.Action.IDLE),this.avatar instanceof e&&this.avatar.play())},f.prototype.processActionBuffer=function(){var b,c,d,e;if(this.buffer)do b=this.buffer.charAt(0),e=a.Direction.fromChar(b),c=!1,d=1,e!==a.Direction.NONE?this.stepInDirection(e):"w"===b?(this.setSpeed(a.Speed.WALK),c=!0):"r"===b?(this.setSpeed(a.Speed.RUN),c=!0):"s"===b?(this.buffer.length>1&&(e=a.Direction.fromChar(this.buffer.charAt(1)),this.setDirection(e),d++),this.setAction(a.Action.SIT)):"t"===b&&(this.buffer.length>1&&(e=a.Direction.fromChar(this.buffer.charAt(1)),this.setDirection(e),d++),this.setAction(a.Action.IDLE)),this.buffer=this.buffer.substr(d);while(c&&this.buffer)},f.prototype.processMovement=function(){var b=this.getPosition(),c=this.directionNormal;g.subtract(this.destination,b,c);var f=g.length(c);g.normalize(c),f<this.speed?(g.scale(c,f),f=0):(g.scale(c,this.speed),f-=this.speed),this.action!==a.Action.MOVE&&this.setAction(a.Action.MOVE),f>0?(c[0]=Math.ceil(c[0]),c[1]=Math.ceil(c[1]),g.add(b,c),d.prototype.setPosition.call(this,b)):(g.set(this.destination,b),d.prototype.setPosition.call(this,b));var h=a.Direction.fromVec3(c);h!==this.direction&&this.setDirection(h),this.step<2?this.step++:(this.step=0,this.avatar instanceof e&&this.avatar.next(!0),this.context.resort()),this.fire("move",this.position)},f.prototype.recalculateAvatarRow=function(){var b;if(this.avatar instanceof e){b=this.direction===a.Direction.NORTH||this.direction===a.Direction.NORTHEAST||this.direction===a.Direction.NORTHWEST?8:this.direction===a.Direction.SOUTH||this.direction===a.Direction.SOUTHEAST||this.direction===a.Direction.SOUTHWEST?2:this.direction===a.Direction.WEST?4:this.direction===a.Direction.EAST?6:2;var c="stop_";this.action!==a.Action.MOVE&&this.avatar.hasKeyframe(c+b)||(c="move_"),this.action===a.Action.SIT&&(c="act_",this.avatar.hasKeyframe(c+b)||(c="move_")),this.avatar.hasKeyframe(c+b)||(c="move_",b="2"),this.avatar.setKeyframe(c+b)}},f.prototype.stepInDirection=function(b){g.set(this.getPosition(),this.destination);var c=a.Direction.toVec3(b);g.add(this.destination,g.scale(c,i))},f}),define("Player",["entity/Actor","Enum","Timer"],function(a,b,c){function d(b,d){this.networkBuffer="",b.network&&(this.onBufferTimer=this.onBufferTimer.bind(this),this.bufferTimer=new c(this.onBufferTimer,e),this.bufferTimer.start(),this.avatarForNetwork=d.avatar,delete d.avatar),a.call(this,b,d)}var e=2e3;return d.prototype=Object.create(a.prototype),d.prototype.constructor=d,d.prototype.destroy=function(){this.bufferTimer&&this.bufferTimer.stop(),a.prototype.destroy.call(this)},d.prototype.onThink=function(){this.checkInput(),a.prototype.onThink.call(this)},d.prototype.onBufferTimer=function(){if(this.networkBuffer.length>0){var a=[this.position[0],this.position[1],this.position[2],this.direction,this.action];this.context.network.emit("move",{buffer:this.networkBuffer,state:a}),this.networkBuffer=""}},d.prototype.checkInput=function(){var a,c,d,e,f=this.context.input,g=this.context.camera,h="",i=b.Direction.NONE;!this.isMoving()&&f.hasFocus()&&(f.isKeyDown(window.KeyEvent.DOM_VK_PAGE_UP)?g.zoom>.2&&(g.zoom-=.1,g.updateTranslation()):f.isKeyDown(window.KeyEvent.DOM_VK_PAGE_DOWN)?g.zoom<2&&(g.zoom+=.1,g.updateTranslation()):f.isKeyDown(window.KeyEvent.DOM_VK_HOME)&&(g.zoom=1,g.updateTranslation()),a=f.isKeyDown(window.KeyEvent.DOM_VK_W)||f.isKeyDown(window.KeyEvent.DOM_VK_UP),d=f.isKeyDown(window.KeyEvent.DOM_VK_S)||f.isKeyDown(window.KeyEvent.DOM_VK_DOWN),e=f.isKeyDown(window.KeyEvent.DOM_VK_A)||f.isKeyDown(window.KeyEvent.DOM_VK_LEFT),c=f.isKeyDown(window.KeyEvent.DOM_VK_D)||f.isKeyDown(window.KeyEvent.DOM_VK_RIGHT),a?i=c?b.Direction.NORTHEAST:e?b.Direction.NORTHWEST:b.Direction.NORTH:d?i=c?b.Direction.SOUTHEAST:e?b.Direction.SOUTHWEST:b.Direction.SOUTH:c?i=b.Direction.EAST:e&&(i=b.Direction.WEST),i!==b.Direction.NONE&&(f.isKeyDown(window.KeyEvent.DOM_VK_C)||f.isKeyDown(window.KeyEvent.DOM_VK_CONTROL)?(this.action!==b.Action.SIT||this.direction!==i)&&(h+="s"+b.Direction.toChar(i)):this.canMove(i)?(f.isKeyDown(window.KeyEvent.DOM_VK_SHIFT)?this.speed!==b.Speed.RUN&&(h+="r"):this.speed!==b.Speed.WALK&&(h+="w"),h+=b.Direction.toChar(i)):this.direction!==i&&(h+="t"+b.Direction.toChar(i))),h.length>0&&this.addToActionBuffer(h))},d.prototype.addToActionBuffer=function(b){this.context.network&&(this.networkBuffer+=b),a.prototype.addToActionBuffer.call(this,b)},d.prototype.say=function(b){this.context.network&&this.context.network.emit("say",{message:b}),a.prototype.say.call(this,b)},d.prototype.setName=function(b){this.context.network?this.context.network.emit("name",{name:b}):a.prototype.setName.call(this,b)},d.prototype.setAvatar=function(b){this.context.network?this.context.network.emit("avatar",{metadata:b}):a.prototype.setAvatar.call(this,b)},d}),define("entity/RemoteActor",["Enum","entity/Actor"],function(a,b){function c(a,c){b.call(this,a,c)}return c.prototype=Object.create(b.prototype),c.prototype.constructor=c,c.prototype.destroy=function(){b.prototype.destroy.call(this)},c}),define("Network",["EventHooks","Utility","entity/Actor","entity/RemoteActor","Player"],function(a,b,c,d,e){function f(c,d){if(b.extend(this,a),!window.io)throw Error("No socket.io support. :(");if(!d.hasOwnProperty("server"))throw Error("No server URI specified.");this.context=c,this.server=d.server,this.token=d.token||null,this.room=d.room||null,this.clientId=null,this.socket=window.io(this.server);var e={connect:this.onConnect,disconnect:this.onDisconnect,err:this.onErr,auth:this.onAuth,join:this.onJoin,leave:this.onLeave,say:this.onSay,move:this.onMove,name:this.onName,avatar:this.onAvatar};for(var f in e)e.hasOwnProperty(f)&&this.socket.on(f,e[f].bind(this))}return f.prototype.emit=function(a,b){this.socket.emit(a,b)},f.prototype.onConnect=function(){var a=this.context.player,b=null;if(!a.hasOwnProperty("avatarForNetwork"))throw new Error("Network onConnect without an avatar!");b=a.avatarForNetwork,this.emit("auth",{token:this.token,room:this.room,name:a.name,avatar:b,state:a.getState()})},f.prototype.onDisconnect=function(a){console.log(a),this.clientId=null,this.fire("disconnect",a),this.context.removeRemoteActors()},f.prototype.onErr=function(a){window.alert(a.message),console.log(a),this.fire("error",a)},f.prototype.onAuth=function(a){this.clientId=a.id,this.room=a.room,this.context.player.id=a.id,this.fire("authenticated",{id:a.id,room:a.room})},f.prototype.onJoin=function(a){if(a.id===this.clientId){var b=this.context.player;if(!(b instanceof e))throw new Error("Local Player instance does not exist");c.prototype.setName.call(b,a.name),c.prototype.setState.call(b,a.state),c.prototype.setAvatar.call(b,a.avatar)}else{var f=this.context.find(a.id);if(f)throw new Error("Duplicate `join` for remote ["+a.id+"]");f=new d(this.context,{id:a.id,name:a.name,avatar:a.avatar,position:a.state.slice(0,3),direction:a.state[3],action:a.state[4]}),this.context.add(f),this.fire("remote.join",{actor:f})}},f.prototype.onLeave=function(a){var b=this.context.find(a.id);if(!(b instanceof d))throw new Error("No Actor associated with remote ["+a.id+"]");this.fire("remote.leave",{actor:b}),b.destroy()},f.prototype.onSay=function(a){var b=this.context.find(a.id);if(b instanceof e)c.prototype.say.call(b,a.message);else{if(!(b instanceof d))throw new Error("No Actor associated with remote ["+a.id+"]");this.fire("remote.say",{actor:b,message:a.message}),b.say(a.message)}},f.prototype.onMove=function(a){var b=this.context.find(a.id);if(b instanceof e)c.prototype.addToActionBuffer.call(b,a.buffer);else{if(!(b instanceof d))throw new Error("No Actor associated with remote ["+a.id+"]");this.fire("remote.say",{actor:b,message:a.message}),b.addToActionBuffer(a.buffer)}},f.prototype.onName=function(a){var b=this.context.find(a.id);if(b instanceof e)c.prototype.setName.call(b,a.name);else{if(!(b instanceof d))throw new Error("No Actor associated with remote ["+a.id+"]");this.fire("remote.name",{actor:b,name:a.name}),b.setName(a.name)}},f.prototype.onAvatar=function(a){var b=this.context.find(a.id);if(b instanceof e)c.prototype.setAvatar.call(b,a.metadata);else{if(!(b instanceof d))throw new Error("No Actor associated with remote ["+a.id+"]");this.fire("remote.avatar",{actor:b,metadata:a.metadata}),b.setAvatar(a.metadata)}},f}),define("World",["EventHooks","Utility","Timer","Audio","Resources","Renderer","Camera","Input","Player","Network","entity/RemoteActor"],function(a,b,c,d,e,f,g,h,i,j,k){function l(c){if(b.extend(this,a),!c.hasOwnProperty("world"))throw Error("What is a fro without a world? You need to specify world data.");this.id=c.world.id||"",this.plugins={},this.renderableEntities=[],this.otherEntities=[],this.templates=c.world.templates||{},this.framerates=[],this.numFramerates=10,this.renderTime=-1,this.loadPlugins(c.plugins||{}),this.resources=new e(this),this.audio=new d(this,c.audio||{}),this.renderer=new f(this,c.renderer||{}),this.input=new h(this,c.input||{}),c.hasOwnProperty("network")&&(this.network=new j(this,c.network)),this.loadEntities(c.world.entities||[]),this.loadPlayer(c.player),this.camera=new g(this,c.camera||{})}var m=1e3/30;return l.prototype.loadPlugins=function(a){var b=require("fro");for(var c in a)if(a.hasOwnProperty(c)){if(!b.plugins.hasOwnProperty(c))throw new Error("Plugin ["+c+"] is not registered.");a[c]===!0&&(a[c]={}),a[c]!==!1&&(this.plugins[c]=new b.plugins[c](this,a[c]))}},l.prototype.loadPlayer=function(a){var c=this.getTemplate(a.template||"default");b.extend(a,c),this.player=new i(this,a),this.add(this.player)},l.prototype.getTemplate=function(a){for(var b=0;b<this.templates.length;b++)if(this.templates[b].id===a)return this.templates[b];return{}},l.prototype.loadEntities=function(a){for(var b,c=[],d=0;d<a.length;d++)b=this.loadEntity(a[d]),b&&c.push(b);return c},l.prototype.loadEntity=function(a){var c,d=require("fro"),e=a.id,f=null,g=this.getTemplate(a.template||"default");if(b.extend(a,g),c=a.type,!d.entities.hasOwnProperty(c))throw new Error("Unknown type ["+c+"] for required entity ["+e+"]");return f=new d.entities[c](this,a),this.add(f),f},l.prototype.isLoading=function(){throw new Error("Not implemented")},l.prototype.find=function(a){for(var b=0;b<this.renderableEntities.length;b++)if(this.renderableEntities[b].id===a)return this.renderableEntities[b];for(var c=0;c<this.otherEntities.length;c++)if(this.otherEntities[c].id===a)return this.otherEntities[c];return null},l.prototype.add=function(a){this.fire("new.entity",a),a.isRenderable?(this.renderableEntities.push(a),this.resort()):this.otherEntities.push(a),this.fire("add.entity",a)},l.prototype.remove=function(a){var b=this.renderableEntities.indexOf(a);return~b?(this.renderableEntities.splice(b,1),this.fire("remove.entity",a),!0):(b=this.otherEntities.indexOf(a),~b?(this.otherEntities.splice(b,1),this.fire("remove.entity",a),!0):!1)},l.prototype.removeRemoteActors=function(){var a,b=[],c=this.renderableEntities.length;for(a=0;c>a;a++)this.renderableEntities[a]instanceof k&&b.push(this.renderableEntities[a]);for(c=b.length,a=0;c>a;a++)b[a].destroy()},l.prototype.resort=function(){this.needsResort=!0},l.prototype.sortRenderables=function(){this.renderableEntities.sort(function(a,b){var c=a.getPosition(),d=b.getPosition();return c[2]<d[2]?-1:c[2]>d[2]?1:c[1]<d[1]?-1:c[1]>d[1]?1:0})},l.prototype.run=function(){this.lastTime=this.startTime=Date.now(),this.heartbeat()},l.prototype.heartbeat=function(){window.requestAnimationFrame(this.heartbeat.bind(this));var a=Date.now(),b=a-this.lastTime;b>m&&(this.render(),this.snapshot(),this.lastTime=a-b%m)},l.prototype.snapshot=function(){if(this.renderTime<0)this.renderTime=(new Date).getTime();else{var a=(new Date).getTime(),b=a-this.renderTime;if(0===b)return;var c=1e3/b;for(this.framerates.push(c);this.framerates.length>this.numFramerates;)this.framerates.shift();this.renderTime=a}},l.prototype.getFramerate=function(){for(var a=0,b=0;b<this.framerates.length;++b)a+=this.framerates[b];var c=a/this.framerates.length;return c=Math.round(c)},l.prototype.render=function(){this.camera.setupViewport(),this.needsResort&&(this.needsResort=!1,this.sortRenderables());for(var a=this.renderableEntities.length,b=0;a>b;b++)this.renderableEntities[b].visible&&this.renderableEntities[b].render()},l.prototype.isPathBlocked=function(a,b){return!1},l.prototype.isRectBlocked=function(a,b){for(var c=0;c<this.renderableEntities.length;c++)if(this.renderableEntities[c]!==b&&this.renderableEntities[c].collides(a))return!0;for(var d=0;d<this.otherEntities.length;d++)if(this.otherEntities[d]!==b&&this.otherEntities[d].collides(a))return!0;return!1},l}),define("entity/Prop",["Utility","entity/Entity"],function(a,b){function c(a,c){if(b.call(this,a,c),this.width=c.w,this.height=c.h,this.isRenderable=!0,this.collisions=[],this.collisionOffset=[0,0],c.hasOwnProperty("collisions")&&this.loadCollisions(c.collisions),c.hasOwnProperty("offset")&&this.setOffset(c.offset),this.setPosition(c.position),this.image=a.resources.load(c.image),!this.image.isLoaded()){var d=this;this.image.bind("onerror",function(){throw new Error("Failed to load prop image for ["+d.id+"]")})}}var d=a.rect;return c.prototype=Object.create(b.prototype),c.prototype.constructor=c,c.prototype.isLoaded=function(){return this.image.isLoaded()},c.prototype.loadCollisions=function(a){this.collisions=[];for(var b=0;b<a.length;b+=4){var c=d.create([a[b],a[b+1],a[b+2],a[b+3]]);this.collisions.push(c)}},c.prototype.render=function(){this.image.render(this.translation,0)},c.prototype.getBoundingBox=function(a){a[0]=this.translation[0],a[1]=this.translation[0],a[2]=this.width,a[3]=this.height},c.prototype.collides=function(a){var b=d.create(a);b[0]=b[0]-this.translation[0]+this.collisionOffset[0],b[1]=b[1]-this.translation[1]+this.collisionOffset[1];var c=this.collisions;if(c)for(var e in c)if(d.intersects(b,c[e]))return!0;return!1},c}),define("entity/Sound",["entity/Entity"],function(a){function b(b,c){if(a.call(this,b,c),this.positional=c.positional||!1,this.loop=c.loop||!1,this.autoplay=c.autoplay||!0,this.ambient=c.ambient||!1,this.positional&&this.setPosition(c.x,c.y),this.context.audio.isAvailable()){this.audioGainNode=this.context.audio.getAudioContext().createGain(),this.setVolume(c.volume||100);var d=this.context.resources.load(c.sound);if(d.isLoaded())this.setBuffer(d.getBuffer());else{var e=this;d.bind("onload",function(){e.setBuffer(this.getBuffer())}).bind("onerror",function(){})}}}return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b.prototype.destroy=function(){this.stop(),this.audioBuffer&&(this.audioGainNode.disconnect(0),this.audioGainNode=void 0),a.prototype.destroy.call(this)},b.prototype.setBuffer=function(a){this.sourceBuffer=a,this.autoplay&&this.play()},b.prototype.setVolume=function(a){a>1&&(a=1),this.volume=a,this.audioGainNode&&(this.audioGainNode.gain.value=a*a)},b.prototype.play=function(){if(this.stop(),this.context.audio.isAvailable()){var a=this.context.audio.getAudioContext().createBufferSource();a.buffer=this.sourceBuffer,a.loop=this.loop,a.start||(a.start=a.noteOn),a.stop||(a.stop=a.noteOff),this.audioBuffer=a,this.audioBuffer.connect(this.audioGainNode),this.context.audio.addConnection(this.audioGainNode,this.ambient),this.context.audio.play(this.audioBuffer)}},b.prototype.stop=function(){this.audioBuffer&&(this.context.audio.stop(this.audioBuffer),this.audioBuffer=void 0)},b}),define("resource/Image",["resource/Resource","Utility"],function(a,b){function c(b,c){if(a.call(this,b,c),this.width=c.width,this.height=c.height,c.hasOwnProperty("shader")&&c.shader?this.shader=b.renderer.getShader(c.shader):this.shader=b.renderer.getDefaultShader(),this.fitToTexture=c.fitToTexture||!0,c.hasOwnProperty("url")){this.url=c.url,this.image=new window.Image,this.image.crossOrigin="",this.image.src=c.url;var d=this;this.image.onload=function(){d.setupTexture(d.image),d.fire("onload",d)},this.image.onerror=function(){d.fire("onerror",d)}}else c.hasOwnProperty("canvas")&&this.setupTexture(c.canvas)}var d=b.mat4;return c.prototype=Object.create(a.prototype),c.prototype.constructor=c,c.prototype.validateMetadata=function(a){for(var b=["width","height"],c=0;c<b.length;c++)if(!a.hasOwnProperty(b[c]))return!1;return!0},c.prototype.setupTexture=function(a){this.texture=this.context.renderer.createTexture(a),this.buildVertexBuffer(),this.buildTextureBuffer()},c.prototype.isLoaded=function(){return!!this.texture},c.prototype.getTexture=function(){return this.texture||this.setupTexture(),this.texture},c.prototype.render=function(a,b,c){var e=this.context.renderer.getGLContext();if(this.isLoaded()){if(!this.texture)throw new Error("No texture loaded for image ["+this.id+"]");if(this.context.renderer.useShader(this.shader),e.mvPushMatrix(),d.translate(e.mvMatrix,a),b&&d.rotateZ(e.mvMatrix,b),e.bindBuffer(e.ARRAY_BUFFER,this.vbuf),e.vertexAttribPointer(this.shader.getAttrib("aVertexPosition"),this.vbuf.itemSize,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,this.tbuf),e.vertexAttribPointer(this.shader.getAttrib("aTextureCoord"),this.tbuf.itemSize,e.FLOAT,!1,0,0),this.shader.bindTexture("uSampler",this.texture),c){if(!this.image)throw new Error("Texture ["+this.id+"] has no image source to clip");var f=0===this.height?1:this.height/this.getTextureHeight(),g=c[0]/this.getTextureWidth(),h=1-f-c[1]/this.getTextureHeight();e.uniform2f(this.shader.getUniform("uClip"),g,h)}else e.uniform2f(this.shader.getUniform("uClip"),0,0);e.setMatrixUniforms(),e.drawArrays(e.TRIANGLE_STRIP,0,this.vbuf.itemCount),e.mvPopMatrix()}},c.prototype.buildVertexBuffer=function(){var a=this.context.renderer.getGLContext();this.vbuf&&a.deleteBuffer(this.vbuf);var b=this.width,c=this.height;this.vbuf=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.vbuf),a.bufferData(a.ARRAY_BUFFER,new window.glMatrixArrayType([b,c,b,0,0,c,0,0]),a.STATIC_DRAW),this.vbuf.itemSize=2,this.vbuf.itemCount=4},c.prototype.buildTextureBuffer=function(){var a=this.context.renderer.getGLContext();this.tbuf&&a.deleteBuffer(this.tbuf),this.tbuf=a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,this.tbuf);var b=0,c=0,d=1,e=1;d=this.width/this.getTextureWidth(),e=this.height/this.getTextureHeight(),a.bufferData(a.ARRAY_BUFFER,new window.glMatrixArrayType([b+d,c,b+d,c+e,b,c,b,c+e]),a.STATIC_DRAW),this.tbuf.itemSize=2,this.tbuf.itemCount=4},c.prototype.getTextureWidth=function(){return this.image?this.image.width:this.width},c.prototype.getTextureHeight=function(){
return this.image?this.image.height:this.height},c}),define("resource/FontImage",["resource/Image","Utility"],function(a,b){function c(b,c){a.call(this,b,c),this.fitToTexture=!1,this.text=c.text,this.width=0,this.height=0,this.maxWidth=c.maxWidth||0,this.fontHeight=c.fontHeight||16,this.fontFamily=c.fontFamily||'"Helvetica Neue", Helvetica, Arial, sans-serif',this.fontColor=c.fontColor||"rgb(0,0,0)",this.generateFontTexture(),this.buildVertexBuffer(),this.buildTextureBuffer()}var d=document.createElement("canvas");return c.prototype=Object.create(a.prototype),c.prototype.constructor=c,c.prototype.validateMetadata=function(a){for(var b=["text"],c=0;c<b.length;c++)if(!a.hasOwnProperty(b[c]))return!1;return!0},c.prototype.generateFontTexture=function(){var a=d.getContext("2d"),c=this.text;if(this.text.length<1)throw new Error("No text");a.font=this.fontHeight+"px "+this.fontFamily;var e,f,g,h,i=[];if(this.maxWidth&&a.measureText(c).width>this.maxWidth?(e=b.createMultilineText(a,c,this.maxWidth,i),e>this.maxWidth&&(e=this.maxWidth)):(i.push(c),e=Math.ceil(a.measureText(c).width)),f=this.fontHeight*i.length,1>e||1>f)throw new Error("Invalid canvas dimensions "+e+"x"+f);d.width=e,d.height=f,a.clearRect(0,0,e,f),g=e/2,h=0,a.fillStyle=this.fontColor,a.textAlign="center",a.textBaseline="top",a.font=this.fontHeight+"px "+this.fontFamily;for(var j=0;j<i.length;j++)h=j*this.fontHeight,a.fillText(i[j],g,h);this.texture=this.context.renderer.createTexture(d),this.width=d.width,this.height=d.height},c.prototype.getTextureWidth=function(){return this.width},c.prototype.getTextureHeight=function(){return this.height},c.prototype.isLoaded=function(){return!0},c}),define("resource/Json",["resource/Resource"],function(a){function b(b,c){a.call(this,b,c),this.url=c.url;var d=new window.XMLHttpRequest;d.open("GET",this.url,!0);var e=this;d.onload=function(){d.status>=200&&d.status<400?(e.json=JSON.parse(d.responseText),e.fire("onload",this)):e.fire("onerror",this)},d.onerror=function(){e.fire("onerror",this)},d.send()}return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b.prototype.validateMetadata=function(a){for(var b=["url"],c=0;c<b.length;c++)if(!a.hasOwnProperty(b[c]))return!1;return!0},b.prototype.isLoaded=function(){return"object"==typeof this.json},b.prototype.getJson=function(){return this.json},b}),define("resource/Shader",["resource/Resource","Utility"],function(a,b){function c(b,c){a.call(this,b,c),this.program=null,this.uniforms=[],this.uniforms.uPMatrix=!1,this.uniforms.uMVMatrix=!1;for(var d=0;d<c.uniforms.length;d++)this.uniforms[c.uniforms[d]]=!1;this.attributes=[];for(var e=0;e<c.attributes.length;e++)this.attributes[c.attributes[e]]=!1;this.fragmentShaderSource=c.fragment,this.vertexShaderSource=c.vertex,this.compileProgram(),this.context.renderer.attachShader(this)}return c.prototype=Object.create(a.prototype),c.prototype.constructor=c,c.prototype.validateMetadata=function(a){for(var b=["id","vertex","fragment"],c=0;c<b.length;c++)if(!a.hasOwnProperty(b[c]))return!1;return!0},c.prototype.bindParameters=function(){var a=this.context.renderer.getGLContext();for(var b in this.uniforms)this.uniforms.hasOwnProperty(b)&&(this.uniforms[b]=a.getUniformLocation(this.program,b));for(var c in this.attributes)this.attributes.hasOwnProperty(c)&&(this.attributes[c]=a.getAttribLocation(this.program,c),a.enableVertexAttribArray(this.attributes[c]))},c.prototype.compileProgram=function(){var a=this.context.renderer.getGLContext();if(!this.vertexShaderSource||!this.fragmentShaderSource)throw new Error("Program ["+this.id+"] missing shader sources");this.program&&a.deleteProgram(this.program),this.program=a.createProgram();var c=a.createShader(a.VERTEX_SHADER);if(a.shaderSource(c,this.vertexShaderSource),a.compileShader(c),!a.getShaderParameter(c,a.COMPILE_STATUS))throw new Error("Program "+this.id+" Vertex Shader Error: "+a.getShaderInfoLog(c)+"\n"+b.getBrowserReport(!0,a));a.attachShader(this.program,c);var d=a.createShader(a.FRAGMENT_SHADER);if(a.shaderSource(d,this.fragmentShaderSource),a.compileShader(d),!a.getShaderParameter(d,a.COMPILE_STATUS))throw new Error("Program "+this.id+" Fragment Shader Error: "+a.getShaderInfoLog(d)+"\n"+b.getBrowserReport(!0,a));if(a.attachShader(this.program,d),a.linkProgram(this.program),!a.getProgramParameter(this.program,a.LINK_STATUS))throw new Error("Could not initialize shaders: "+a.getProgramInfoLog(this.program)+"\n"+b.getBrowserReport(!0,a));this.bindParameters()},c.prototype.isLoaded=function(){return!0},c.prototype.getAttrib=function(a){if(!(a in this.attributes))throw new Error("Attribute "+a+" does not exist in program ["+this.id+"]");return this.attributes[a]},c.prototype.getUniform=function(a){if(!(a in this.uniforms))throw new Error("Uniform "+a+" does not exist in program ["+this.id+"]");return this.uniforms[a]},c.prototype.getProgram=function(){return this.program},c.prototype.bindTexture=function(a,b){var c=this.context.renderer.getGLContext();c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,b),c.uniform1i(this.getUniform(a),0)},c}),define("resource/Sound",["resource/Resource"],function(a){function b(b,c){a.call(this,b,c),this.url=c.url,this.buffer=null;var d=new window.XMLHttpRequest;d.open("GET",this.url,!0),d.responseType="arraybuffer";var e=this;d.onload=function(){var a=b.audio.getAudioContext();a?a.decodeAudioData(d.response,function(a){e.buffer=a,e.fire("onload",e)},function(){e.fire("onerror",e)}):e.fire("onerror",e)},d.onerror=function(){e.fire("onerror",e)},d.send()}return b.prototype=Object.create(a.prototype),b.prototype.constructor=b,b.prototype.validateMetadata=function(a){for(var b=["url"],c=0;c<b.length;c++)if(!a.hasOwnProperty(b[c]))return!1;return!0},b.isLoaded=function(){return!!this.buffer},b.getBuffer=function(){return this.buffer},b}),define("fro",["require","World","Timer","Utility","Enum","entity/Entity","entity/Actor","entity/Prop","entity/RemoteActor","entity/Sound","resource/Animation","resource/FontImage","resource/Image","resource/Json","resource/Shader","resource/Sound"],function(a){return{VERSION:"0.1.0",World:a("World"),Timer:a("Timer"),utils:a("Utility"),"enum":a("Enum"),entities:{Entity:a("entity/Entity"),Actor:a("entity/Actor"),Prop:a("entity/Prop"),RemoteActor:a("entity/RemoteActor"),Sound:a("entity/Sound")},resources:{Animation:a("resource/Animation"),FontImage:a("resource/FontImage"),Image:a("resource/Image"),Json:a("resource/Json"),Shader:a("resource/Shader"),Sound:a("resource/Sound")},plugins:{}}})}();
//# sourceMappingURL=fro.map